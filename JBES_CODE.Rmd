---
title: "Gaussian_Process_Code"
author: "Chiwan Kim"
date: "2/3/2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# In order to change to calls -> change the testing and training index numbers, change blackscholes formula (-1,1), change total_puts to total_calls
```

##Part 1: Standard Gaussian Process

1-1: Fitting

```{r Fitting_SGP, warning = FALSE}
library(rstan)
source("gp.utility.R")

# Fitting GP model
stan_dat <- read_rdump('Financial_Data_Put_American.R')
fit_gp_SGP_American <- stan(file="gp-fit-6dimension_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_SGP_American, pars = c('theta','sigma2','gamma2'))
sum_gp_SGP_American <- extract(fit_gp_SGP_American,permuted=FALSE)
```

```{r Computing Means for prediction_SGP}
# Predicting from GP model
post_mean_theta_1_SGP <- mean(sum_gp_SGP_American[,1,1]) #theta
post_mean_theta_2_SGP <- mean(sum_gp_SGP_American[,1,2]) #theta
post_mean_theta_3_SGP <- mean(sum_gp_SGP_American[,1,3]) #theta
post_mean_theta_4_SGP <- mean(sum_gp_SGP_American[,1,4]) #theta
post_mean_theta_5_SGP <- mean(sum_gp_SGP_American[,1,5]) #theta
post_mean_theta_6_SGP <- mean(sum_gp_SGP_American[,1,6]) #theta
post_mean_sigma2_SGP <- mean(sum_gp_SGP_American[,1,7]) #sigma2
post_mean_gamma2_SGP <- mean(sum_gp_SGP_American[,1,8]) #gamma2
post_mean_mu_SGP <- mean(sum_gp_SGP_American[,1,9])


```

```{r Blackscholes and assigning test data-1}
test_start <- 323 #06/10 Puts
test_end <- 559 #06/14 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
x2 <- cbind(x_1,x_2,x_3,x_4,x_5,x_6)
```


```{r computing blackscholes for test}
x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))


library('qrmtools')
library('ragtop')
blackscholes_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
}

```

1-2: Predictions

```{r Predictions_SGP}

post_data_SGP_American <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_SGP_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

##Part2:  BS Integrated SGP

2-1: Fitting

```{r Fitting_Bdrycov,warning = FALSE}
# Fitting GP model for Bdrycov
fit_gp_bs_American <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_bs_American, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American <- extract(fit_gp_bs_American,permuted=FALSE)
```

```{r Computing means for prediction_Bdrycov}
# Predicting from GP model - 2 dimensional case
post_mean_theta_1_bs <- mean(sum_gp_bs_American[,1,1]) #theta
post_mean_theta_2_bs <- mean(sum_gp_bs_American[,1,2]) #theta
post_mean_theta_3_bs <- mean(sum_gp_bs_American[,1,3]) #theta
post_mean_theta_4_bs <- mean(sum_gp_bs_American[,1,4]) #theta
post_mean_theta_5_bs <- mean(sum_gp_bs_American[,1,5]) #theta
post_mean_theta_6_bs <- mean(sum_gp_bs_American[,1,6]) #theta
post_mean_sigma2_bs <- mean(sum_gp_bs_American[,1,7]) #sigma2
post_mean_gamma2_bs <- mean(sum_gp_bs_American[,1,8]) #gamma2
post_mean_mu_bs <- stan_dat$blackscholes
```


2-2: Predictions

```{r Predictions_Bdrycov}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)
post_data_bs_American <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

##Part 3 Predictions Versus Truth

3-1: Computing Means Standard GP

```{r Mean & SD of Predictions_SGP}

#Computing Mean
y_predict_values_SGP <- extract(pred_gp_SGP,permuted=FALSE)
y_mean_values_SGP <- c(colMeans(y_predict_values_SGP))
y_mean_values_SGP <- y_mean_values_SGP[1:(length(y_mean_values_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_SGP <- summary(pred_gp_SGP, sd=c("sd"))$summary
pred_gp_sd_SGP <- pred_gp_summary_SGP[, c("sd")]
y_sd_values_SGP <- pred_gp_sd_SGP[1:(length(pred_gp_sd_SGP)-1)]
```

3-2: Computing Means bs

```{r Mean & SD of Predictions_bs}
post_data_bs_American <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
#Computing Mean
y_predict_values_bs <- extract(pred_gp_bs,permuted=FALSE)
y_mean_values_bs <- c(colMeans(y_predict_values_bs))
y_mean_values_bs <- y_mean_values_bs[1:(length(y_mean_values_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_bs <- summary(pred_gp_bs, sd=c("sd"))$summary
pred_gp_sd_bs <- pred_gp_summary_bs[, c("sd")]
y_sd_values_bs <- pred_gp_sd_bs[1:(length(pred_gp_sd_bs)-1)]
```

3-3: Plotting Predicted Values against Truth

```{r prediction accuracy}
par(mfrow=c(1,3))
#Plotting Standard GP
ggplot(mapping=aes(x=log(y_mean_values_SGP),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting bs
ggplot(mapping=aes(x=log(y_mean_values_bs),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


#Plotting Blackscholes
ggplot(mapping=aes(x=log(blackscholes_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

#MSE
library('MLmetrics')
MSE(y_mean_values_SGP,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(y_mean_values_bs,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(blackscholes_test,stan_dat$total_puts_American$mid_price[test_start:test_end])
```

##Part 4 MSE over Time

4-1: Plotting MSE over time


```{r}
#MSE
library('MLmetrics')
SGP_MSE_0610 <- MSE(y_mean_values_SGP[1:71],stan_dat$total_puts_American$mid_price[323:393])
SGP_MSE_0611 <- MSE(y_mean_values_SGP[72:143],stan_dat$total_puts_American$mid_price[394:465])
SGP_MSE_0612 <- MSE(y_mean_values_SGP[144:164],stan_dat$total_puts_American$mid_price[466:486])
SGP_MSE_0613 <- MSE(y_mean_values_SGP[165:200],stan_dat$total_puts_American$mid_price[487:522])
SGP_MSE_0614 <- MSE(y_mean_values_SGP[201:237],stan_dat$total_puts_American$mid_price[523:559])
SGP_MSE <- rbind(SGP_MSE_0610,SGP_MSE_0611,SGP_MSE_0612,SGP_MSE_0613,SGP_MSE_0614)

BS_SGP_MSE_0610 <- MSE(y_mean_values_bs[1:71],stan_dat$total_puts_American$mid_price[323:393])
BS_SGP_MSE_0611 <- MSE(y_mean_values_bs[72:143],stan_dat$total_puts_American$mid_price[394:465])
BS_SGP_MSE_0612 <- MSE(y_mean_values_bs[144:164],stan_dat$total_puts_American$mid_price[466:486])
BS_SGP_MSE_0613 <- MSE(y_mean_values_bs[165:200],stan_dat$total_puts_American$mid_price[487:522])
BS_SGP_MSE_0614 <- MSE(y_mean_values_bs[201:237],stan_dat$total_puts_American$mid_price[523:559])
BS_SGP_MSE <- rbind(BS_SGP_MSE_0610,BS_SGP_MSE_0611,BS_SGP_MSE_0612,BS_SGP_MSE_0613,BS_SGP_MSE_0614)

BS_MSE_0610 <- MSE(blackscholes_test[1:71],stan_dat$total_puts_American$mid_price[323:393])
BS_MSE_0611 <- MSE(blackscholes_test[72:143],stan_dat$total_puts_American$mid_price[394:465])
BS_MSE_0612 <- MSE(blackscholes_test[144:164],stan_dat$total_puts_American$mid_price[466:486])
BS_MSE_0613 <- MSE(blackscholes_test[165:200],stan_dat$total_puts_American$mid_price[487:522])
BS_MSE_0614 <- MSE(blackscholes_test[201:237],stan_dat$total_puts_American$mid_price[523:559])
BS_MSE <- rbind(BS_MSE_0610,BS_MSE_0611,BS_MSE_0612,BS_MSE_0613,BS_MSE_0614)

MSE_data <- as.data.frame(rbind(SGP_MSE,BS_SGP_MSE,BS_MSE))

MSE_data$date <- c(as.Date('00/00/0000', format = '%m/%d/%Y'))
MSE_data$date[c(1,6,11)] <- as.Date('06/10/2019', format = '%m/%d/%Y')
MSE_data$date[c(2,7,12)] <- as.Date('06/11/2019', format = '%m/%d/%Y')
MSE_data$date[c(3,8,13)] <- as.Date('06/12/2019', format = '%m/%d/%Y')
MSE_data$date[c(4,9,14)] <- as.Date('06/13/2019', format = '%m/%d/%Y')
MSE_data$date[c(5,10,15)] <- as.Date('06/14/2019', format = '%m/%d/%Y')

MSE_data$Method <- "Method"
MSE_data$Method[1:5] <- "SGP"
MSE_data$Method[6:10] <- "Black-Scholes Integrated_SGP"
MSE_data$Method[11:15] <- "Black-Scholes"

MSE_data <- MSE_data %>% 
  rename(MSE_values = V1)
  
#Plotting Blackscholes
ggplot(data=MSE_data, mapping=aes(x=date, y=MSE_values, colour = Method, shape = Method)) +
  geom_point(size = 2) +
  geom_line() +
  labs(title = "MSE Across Time",
       x = "Date",
       y = "Mean Squared Error") +
  theme_bw() +
  theme(text=element_text(size=16))
```


##Part 5 Interpretations

5-1: Contour Plots of Forward Price & Strike Price

```{r contour plots_forward_strike}
library(plotly)
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,1],K=x2_cont_bs[row,2],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,3],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]


max_strike <- max(stan_dat$total_puts_American$strike_price)
min_strike <- min(stan_dat$total_puts_American$strike_price)
max_spot <- max(stan_dat$total_puts_American$forward_price)
min_spot <- min(stan_dat$total_puts_American$forward_price)

color <- matrix(y_mean_values_cont_SGP, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike))
dim(color) <- dim(matrix(y_mean_values_cont_SGP, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)))

fig_sgp_price <- plot_ly(x=dim1*(max_spot-min_spot)+min_spot, y=dim2*(max_strike-min_strike)+min_strike, z=matrix(y_mean_values_cont_SGP, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_sgp_price <- fig_sgp_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_sgp_price <- fig_sgp_price %>% layout(title = 'SGP', 
  scene = list(xaxis = list(title='Spot Price'), yaxis = list(title='Strike Price'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_sgp_price



#Contour of Variance

color <- matrix(y_sd_values_cont_SGP, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike))
dim(color) <- dim(matrix(y_sd_values_cont_SGP, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)))

fig_sgp_sd <- plot_ly(x=dim1*(max_spot-min_spot)+min_spot, y=dim2*(max_strike-min_strike)+min_strike, z=matrix(y_sd_values_cont_SGP, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)), type='surface',surfacecolor=color,
        colors=c('blue','yellow'))
fig_sgp_sd <- fig_sgp_sd %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_sgp_sd <- fig_sgp_sd %>% layout(title = 'SGP', 
  scene = list(xaxis = list(title='Spot Price'), yaxis = list(title='Strike Price'), zaxis= list(title='Standard Deviation'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_sgp_sd


#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

color <- matrix(y_mean_values_cont_bs, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike))
dim(color) <- dim(matrix(y_mean_values_cont_bs, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)))

fig_bs_price <- plot_ly(x=dim1*(max_spot-min_spot)+min_spot, y=dim2*(max_strike-min_strike)+min_strike, z=matrix(y_mean_values_cont_bs, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_bs_price <- fig_bs_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_price <- fig_bs_price %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Spot Price'), yaxis = list(title='Strike Price'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_price

##Contour of Variance
color <- matrix(y_sd_values_cont_bs, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike))
dim(color) <- dim(matrix(y_sd_values_cont_bs, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)))

fig_bs_sd <- plot_ly(x=dim1*(max_spot-min_spot)+min_spot, y=dim2*(max_strike-min_strike)+min_strike, z=matrix(y_sd_values_cont_bs, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)), type='surface',surfacecolor=color,
        colors=c('blue','yellow'))
fig_bs_sd <- fig_bs_sd %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_sd <- fig_bs_sd %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Spot Price'), yaxis = list(title='Strike Price'), zaxis= list(title='Standard Deviation'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_sd


color <- matrix(blackscholes_test_cont, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike))
dim(color) <- dim(matrix(blackscholes_test_cont, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)))

fig_blackscholes_price <- plot_ly(x=dim1*(max_spot-min_spot)+min_spot, y=dim2*(max_strike-min_strike)+min_strike, z=matrix(blackscholes_test_cont, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_blackscholes_price <- fig_blackscholes_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_blackscholes_price <- fig_blackscholes_price %>% layout(title = 'Black-Scholes', 
  scene = list(xaxis = list(title='Spot Price'), yaxis = list(title='Strike Price'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_blackscholes_price

```

5-2: Contour Plots of Implied Volatility & Time to Expiration

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,4],r=x2_cont_bs[row,6],t=x2_cont_bs[row,2],vola=x2_cont_bs[row,1],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]

max_impl_vol <- max(stan_dat$total_puts_American$impl_volatility)
min_impl_vol <- min(stan_dat$total_puts_American$impl_volatility)
max_time <- max(stan_dat$total_puts_American$time_to_exp)
min_time <- min(stan_dat$total_puts_American$time_to_exp)

color <- matrix(y_mean_values_cont_SGP, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(y_mean_values_cont_SGP, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_sgp_price <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(y_mean_values_cont_SGP, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_sgp_price <- fig_sgp_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_sgp_price <- fig_sgp_price %>% layout(title = 'SGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_sgp_price
#Contour of Variance

color <- matrix(y_sd_values_cont_SGP, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(y_sd_values_cont_SGP, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_sgp_sd <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(y_sd_values_cont_SGP, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('blue','yellow'))
fig_sgp_sd <- fig_sgp_sd %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_sgp_sd <- fig_sgp_sd %>% layout(title = 'SGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Standard Deviation'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_sgp_sd

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

color <- matrix(y_mean_values_cont_bs, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(y_mean_values_cont_bs, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_bs_price <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(y_mean_values_cont_bs, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_bs_price <- fig_bs_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_price <- fig_bs_price %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_price

##Contour of Variance
color <- matrix(y_sd_values_cont_bs, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(y_sd_values_cont_bs, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_bs_sd <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(y_sd_values_cont_bs, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('blue','yellow'))
fig_bs_sd <- fig_bs_sd %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_sd <- fig_bs_sd %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Standard Deviation'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_sd


color <- matrix(blackscholes_test_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(blackscholes_test_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_blackscholes_price <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(blackscholes_test_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_blackscholes_price <- fig_blackscholes_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_blackscholes_price <- fig_blackscholes_price %>% layout(title = 'Black-Scholes', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_blackscholes_price

```

5-3: Contour Plots of Strike Price and Implied Volatility

```{r contour plots_rates_time}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25) 
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,1],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,2],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]



color <- matrix(y_mean_values_cont_SGP, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(y_mean_values_cont_SGP, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_sgp_price <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(y_mean_values_cont_SGP, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_sgp_price <- fig_sgp_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_sgp_price <- fig_sgp_price %>% layout(title = 'SGP', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied Volatility'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_sgp_price
#Contour of Variance

color <- matrix(y_sd_values_cont_SGP, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(y_sd_values_cont_SGP, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_sgp_sd <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(y_sd_values_cont_SGP, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('blue','yellow'))
fig_sgp_sd <- fig_sgp_sd %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_sgp_sd <- fig_sgp_sd %>% layout(title = 'SGP', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied V0latility'), zaxis= list(title='Standard Deviation'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_sgp_sd

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

color <- matrix(y_mean_values_cont_bs, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(y_mean_values_cont_bs, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_bs_price <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(y_mean_values_cont_bs, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_bs_price <- fig_bs_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_price <- fig_bs_price %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied V0latility'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_price

##Contour of Variance
color <- matrix(y_sd_values_cont_bs, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(y_sd_values_cont_bs, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_bs_sd <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(y_sd_values_cont_bs, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('blue','yellow'))
fig_bs_sd <- fig_bs_sd %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_sd <- fig_bs_sd %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied V0latility'), zaxis= list(title='Standard Deviation'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_sd


color <- matrix(blackscholes_test_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(blackscholes_test_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_blackscholes_price <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(blackscholes_test_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_blackscholes_price <- fig_blackscholes_price %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_blackscholes_price <- fig_blackscholes_price %>% layout(title = 'Black-Scholes', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied V0latility'), zaxis= list(title='Predicted Price'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_blackscholes_price
```

## Part 6: Standard Deviation of Predicted Values

6-1: Plotting Standard Deviation of Predictions

```{r}
par(mfrow=c(1,3))
ggplot(mapping = aes(x = seq(1:237),y=y_sd_values_SGP)) + geom_point(size = 2)+
  ylim(0,0.5)+ labs(title = "Standard Deviation of SGP",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

ggplot(mapping = aes(x = seq(1:237),y=y_sd_values_bs)) + geom_point(size = 2)+
  ylim(0,0.5)+
  labs(title = "Standard Deviation of Black-Scholes Integrated SGP",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

ggplot(mapping = aes(x = seq(1:237),y=rep(0,237))) + geom_point(size = 2)+
  ylim(0,0.5)+
  labs(title = "Standard Deviation of Black-Scholes",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

mean(y_sd_values_SGP)
mean(y_sd_values_bs)
mean(0)
```

##Part 7 Discrepancy Modeling

7-1: Computing Discrepancy

```{r}
Discrepancy <- y_mean_values_bs - blackscholes_test

library('MLmetrics')
Discrepnacy_0610 <- mean(Discrepancy[1:71])
Discrepancy_0611 <- mean(Discrepancy[72:143])
Discrepancy_0612 <- mean(Discrepancy[144:164])
Discrepancy_0613 <- mean(Discrepancy[165:200])
Discrepancy_0614 <- mean(Discrepancy[201:237])
Discrepancy_data <- as.data.frame(rbind(SGP_MSE_0610,SGP_MSE_0611,SGP_MSE_0612,SGP_MSE_0613,SGP_MSE_0614))

Discrepancy_data$date <- c(as.Date('00/00/0000', format = '%m/%d/%Y'))
Discrepancy_data$date[1] <- as.Date('06/10/2019', format = '%m/%d/%Y')
Discrepancy_data$date[2] <- as.Date('06/11/2019', format = '%m/%d/%Y')
Discrepancy_data$date[3] <- as.Date('06/12/2019', format = '%m/%d/%Y')
Discrepancy_data$date[4] <- as.Date('06/13/2019', format = '%m/%d/%Y')
Discrepancy_data$date[5] <- as.Date('06/14/2019', format = '%m/%d/%Y')

Discrepancy_data <- Discrepancy_data %>% 
  rename(Discrepancy_values = V1)
  
plot(Discrepancy, main = "Plotting Discrepancy Between BSGP and Black-Scholes", xlab = "Plot Points", ylab = "Discrepancy in $")

#Plotting Blackscholes
ggplot(data=Discrepancy_data, mapping=aes(x=date, y=Discrepancy_values)) +
  geom_point(size = 2) +
  geom_line() +
  labs(title = "Plotting Mean Discrepancy Across Time",
       x = "Date",
       y = "Discrepancy in $") +
  theme_bw() +
  theme(text=element_text(size=16))
```

7-2: Discrepancy Contour Plots of Forward Price & Strike Price 

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,1],K=x2_cont_bs[row,2],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,3],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data


pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

color <- matrix(Discrepancy_function, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike))
dim(color) <- dim(matrix(Discrepancy_function, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)))

fig_bs_dis <- plot_ly(x=dim1*(max_spot-min_spot)+min_spot, y=dim2*(max_strike-min_strike)+min_strike, z=matrix(Discrepancy_function, length(dim1*(max_spot-min_spot)+min_spot), length(dim2*(max_strike-min_strike)+min_strike)), type='surface',surfacecolor=color,
        colors=c('yellow','red'))
fig_bs_dis <- fig_bs_dis %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_dis <- fig_bs_dis %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Spot Price'), yaxis = list(title='Strike Price'), zaxis= list(title='Discrepancy'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_dis
```

7-3: Discrepancy Contour Plots of Implied Volatility & Time to Expiration

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,4],r=x2_cont_bs[row,6],t=x2_cont_bs[row,2],vola=x2_cont_bs[row,1],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

color <- matrix(Discrepancy_function, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(Discrepancy_function, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_bs_dis <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(Discrepancy_function, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('yellow','red'))
fig_bs_dis <- fig_bs_dis %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_dis <- fig_bs_dis %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Discrepancy'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_dis
```

7-4: Discrepancy Contour Plots of Strike Price & Implied Volatility

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,1],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,2],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

color <- matrix(Discrepancy_function, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(Discrepancy_function, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_bs_dis <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(Discrepancy_function, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('yellow','red'))
fig_bs_dis <- fig_bs_dis %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs_dis <- fig_bs_dis %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied Volatility'), zaxis= list(title='Discrepancy'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs_dis

```

##Part 8: Other Machine Learning Methods

8-1: Fitting ANN

```{r Fitting_ANN}
library(rstan)
source("gp.utility.R")
library(neuralnet)

# Fitting ANN model
stan_dat <- read_rdump('Financial_Data_Put_American.R')
train <- data.frame(stan_dat$train)
n <- names(data.frame(stan_dat$train))
nn <- neuralnet(y_scaled ~ x_1 + x_2 + x_3 + x_4 + x_5 + x_6, data=train, hidden=c(5,3),linear.output=TRUE ,threshold=0.01)
plot(nn)
```

8-2: Testing ANN

```{r Testing_ANN}
#Testing
test_start <- 323 #06/10 Puts
test_end <- 559 #06/14 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
y_scaled <- as.numeric(stan_dat$total_puts_American$mid_price_scaled[test_start:test_end])
test <- data.frame(cbind(x_1,x_2,x_3,x_4,x_5,x_6,y_scaled))


predict_testNN <- neuralnet::compute(nn, test[,c(1:6)])
predict_testNN <- (predict_testNN$net.result * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(stan_dat$total_puts_American$mid_price[test_start:test_end], predict_testNN, col='blue', pch=16, ylab = "predicted price NN", xlab = "real price")
abline(0,1)


MSE(predict_testNN,stan_dat$total_puts_American$mid_price[test_start:test_end])
```

8-3 Fitting & Testing Bagging

```{r Fitting_Random Forest}
#Bagging
library(tree)
library(randomForest)

bagging <- randomForest(y_scaled~., data = train, mtry = 6, importance = TRUE)
bagging

yhat.bag <- predict(bagging, newdata = test)
yhat.bag <- (yhat.bag * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(yhat.bag, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((yhat.bag - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)


#Random Forest
rf <- randomForest(y_scaled~., data = train, mtry = 2, importance = TRUE)
yhat.rf <- predict(rf, newdata = test)
yhat.rf <- (yhat.rf * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(yhat.rf, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((yhat.rf - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)
```

8-4 Fitting & Testing Binomial Option Trees

```{r}
library(derivmkts)

x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))

binom_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  binom_test[row] <- binomopt(s=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],k=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],v=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],tt=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],d=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row], nstep = 6000, american=TRUE, putopt=TRUE)
}

plot(binom_test, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((binom_test - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)
```


8-5 Summary of Other Machine Learning Methods

```{r summary of results for all methods}
par(mfrow=c(2,3))
#Plotting Standard GP
ggplot(mapping=aes(x=log(y_mean_values_SGP),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting bs
ggplot(mapping=aes(x=log(y_mean_values_bs),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


#Plotting Blackscholes
ggplot(mapping=aes(x=log(blackscholes_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

#Plotting Artificial Neural Networks
ggplot(mapping=aes(x=log(predict_testNN),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Neural Network",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Bagging
ggplot(mapping=aes(x=log(yhat.bag),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Bagging",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Random Forest
ggplot(mapping=aes(x=log(yhat.rf),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Random Forest",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Binomial Option Tree
ggplot(mapping=aes(x=log(binom_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Binomial Option Tree",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#MSE
library('MLmetrics')
MSE(y_mean_values_SGP,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(y_mean_values_bs,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(blackscholes_test,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(predict_testNN,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(yhat.bag,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(yhat.rf,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(binom_test,stan_dat$total_puts_American$mid_price[test_start:test_end])

#Computational Time
library('base')
#SGP
system.time(stan(file="gp-fit-6dimension_SGP.stan", data=stan_dat,
               iter=100, chains=1))
system.time(stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_SGP_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param'))

#BSGP
system.time(stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1))
system.time(stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param'))

#BS
system.time(for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
})

#Neural Net
system.time(neuralnet(y_scaled ~ x_1 + x_2 + x_3 + x_4 + x_5 + x_6, data=train, hidden=c(5,3),linear.output=TRUE ,threshold=0.01))
system.time(neuralnet::compute(nn, test[,c(1:6)]))

#Bagging
system.time(randomForest(y_scaled~., data = train, mtry = 6, importance = TRUE))
system.time(predict(bagging, newdata = test))

#Random Forest
system.time(randomForest(y_scaled~., data = train, mtry = 2, importance = TRUE))
system.time(predict(rf, newdata = test))

#Binomial Option Tree
system.time(for (row in 1:nrow(data.frame(x2_bs))){
  binom_test[row] <- binomopt(s=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],k=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],v=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],tt=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],d=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row], nstep = 6000, american=TRUE, putopt=TRUE)
})
```

## Part 9: Delta Hedging Back-test

```{r}
stan_dat <- read_rdump('Financial_Data_Put_American.R')
fit_gp_bs_American <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_bs_American, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American <- extract(fit_gp_bs_American,permuted=FALSE)

post_mean_theta_1_bs <- mean(sum_gp_bs_American[,1,1]) #theta
post_mean_theta_2_bs <- mean(sum_gp_bs_American[,1,2]) #theta
post_mean_theta_3_bs <- mean(sum_gp_bs_American[,1,3]) #theta
post_mean_theta_4_bs <- mean(sum_gp_bs_American[,1,4]) #theta
post_mean_theta_5_bs <- mean(sum_gp_bs_American[,1,5]) #theta
post_mean_theta_6_bs <- mean(sum_gp_bs_American[,1,6]) #theta
post_mean_sigma2_bs <- mean(sum_gp_bs_American[,1,7]) #sigma2
post_mean_gamma2_bs <- mean(sum_gp_bs_American[,1,8]) #gamma2
post_mean_mu_bs <- stan_dat$blackscholes

test_start <- 323 #06/10 Puts
test_end <- 559 #06/14 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
x2 <- cbind(x_1,x_2,x_3,x_4,x_5,x_6)

x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))


library('qrmtools')
library('ragtop')
blackscholes_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
}

post_data_bs_American <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

```

```{r}
library(derivmkts)
BS_Delta <- greeks(bsput(s=as.numeric(x2_bs[,1]), k=as.numeric(x2_bs[,2]), v=as.numeric(x2_bs[,3]), r=as.numeric(x2_bs[,6]), tt=as.numeric(x2_bs[,4]), d=as.numeric(x2_bs[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta
```

```{r}
vector_c_values <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_c_values <- extract(vector_c_values,permuted=FALSE)
exp_vector_c_values <- c(colMeans(exp_vector_c_values))
exp_vector_c_values <- exp_vector_c_values[1:(length(exp_vector_c_values)-1)]


vector_k_values <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_k_values <- extract(vector_k_values,permuted=FALSE)
exp_vector_k_values <- c(colMeans(exp_vector_k_values))
exp_vector_k_values <- exp_vector_k_values[1:(length(exp_vector_k_values)-1)]
```

```{r}
vector_k <- matrix(exp_vector_k_values, nrow(x2), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta <- BS_Delta + vector_k %*% exp_vector_c_values
```

```{r}
ggplot(mapping=aes(x=abs(BS_Delta),y=abs(stan_dat$total_puts_American$delta[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes",
       x = "Predicted Delta",
       y = "Observed Delta") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

ggplot(mapping=aes(x=abs(BSGP_Delta),y=abs(stan_dat$total_puts_American$delta[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Delta",
       y = "Observed Delta") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


ggplot(mapping=aes(x=abs(BSGP_Delta),y=abs(BS_Delta))) +
  geom_point() +
  labs(title = "BSGP vs BS - Predicted Absolute Delta Values",
       x = "Predicted BSGP Delta",
       y = "Predicted BS Delta") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

```


##Interpretations

5-1: Contour Plots of Forward Price & Strike Price

```{r contour plots_forward_strike}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 15)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 15)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 15)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 15)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,1],K=x2_cont_bs[row,2],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,3],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=length(x2_cont[,1]), bs = blackscholes_test_cont,variables = 6)


# post_data


BS_Delta_cont <- greeks(bsput(s=as.numeric(x2_cont[,1]), k=as.numeric(x2_cont[,2]), v=as.numeric(x2_cont[,3]), r=as.numeric(x2_cont[,6]), tt=as.numeric(x2_cont[,4]), d=as.numeric(x2_cont[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

vector_c_values_cont <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_cont_bs,iter=1, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_c_values_cont <- extract(vector_c_values_cont,permuted=FALSE)
exp_vector_c_values_cont <- c(colMeans(exp_vector_c_values_cont))
exp_vector_c_values_cont <- exp_vector_c_values_cont[1:(length(exp_vector_c_values_cont)-1)]


vector_k_values_cont <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_cont_bs,iter=1, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_k_values_cont <- extract(vector_k_values_cont,permuted=FALSE)
exp_vector_k_values_cont <- c(colMeans(exp_vector_k_values_cont))
exp_vector_k_values_cont <- exp_vector_k_values_cont[1:(length(exp_vector_k_values_cont)-1)]


vector_k_cont <- matrix(exp_vector_k_values_cont, nrow(x2_cont), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta_cont <- BS_Delta_cont + vector_k_cont %*% exp_vector_c_values_cont

Delta_disc <- BSGP_Delta_cont - BS_Delta_cont

color <- matrix(BSGP_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot))
dim(color) <- dim(matrix(BSGP_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot)))

fig_bs <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_spot-min_spot)+min_spot, z=matrix(BSGP_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_bs <- fig_bs %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs <- fig_bs %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Spot Price'), zaxis= list(title='Delta'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs


color <- matrix(BS_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot))
dim(color) <- dim(matrix(BS_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot)))

fig_blackscholes <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_spot-min_spot)+min_spot, z=matrix(BS_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_blackscholes <- fig_blackscholes %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_blackscholes <- fig_blackscholes %>% layout(title = 'Black-Scholes', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Spot Price'), zaxis= list(title='Delta'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_blackscholes


##Delta Discrepancies

color <- matrix(Delta_disc, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot))
dim(color) <- dim(matrix(Delta_disc, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot)))

fig_disc <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_spot-min_spot)+min_spot, z=matrix(Delta_disc, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_spot-min_spot)+min_spot)), type='surface',surfacecolor=color,
        colors=c('yellow','red'))
fig_disc <- fig_disc %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_disc <- fig_disc %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Spot Price'), zaxis= list(title='Delta Discrepancy'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_disc
```

5-2: Contour Plots of Implied Volatility & Time to Expiration

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 15)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 15)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 15)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 15)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,4],r=x2_cont_bs[row,6],t=x2_cont_bs[row,2],vola=x2_cont_bs[row,1],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data


BS_Delta_cont <- greeks(bsput(s=as.numeric(x2_cont[,1]), k=as.numeric(x2_cont[,2]), v=as.numeric(x2_cont[,3]), r=as.numeric(x2_cont[,6]), tt=as.numeric(x2_cont[,4]), d=as.numeric(x2_cont[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

vector_c_values_cont <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_cont_bs,iter=1, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_c_values_cont <- extract(vector_c_values_cont,permuted=FALSE)
exp_vector_c_values_cont <- c(colMeans(exp_vector_c_values_cont))
exp_vector_c_values_cont <- exp_vector_c_values_cont[1:(length(exp_vector_c_values_cont)-1)]


vector_k_values_cont <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_cont_bs,iter=1, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_k_values_cont <- extract(vector_k_values_cont,permuted=FALSE)
exp_vector_k_values_cont <- c(colMeans(exp_vector_k_values_cont))
exp_vector_k_values_cont <- exp_vector_k_values_cont[1:(length(exp_vector_k_values_cont)-1)]


vector_k_cont <- matrix(exp_vector_k_values_cont, nrow(x2_cont), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta_cont <- BS_Delta_cont + vector_k_cont %*% exp_vector_c_values_cont

Delta_disc <- BSGP_Delta_cont - BS_Delta_cont

color <- matrix(BSGP_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(BSGP_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_bs <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(BSGP_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_bs <- fig_bs %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs <- fig_bs %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Delta'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs


color <- matrix(BS_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(BS_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_blackscholes <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(BS_Delta_cont, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_blackscholes <- fig_blackscholes %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_blackscholes <- fig_blackscholes %>% layout(title = 'Black-Scholes', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Delta'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_blackscholes


##Delta Discrepancies

color <- matrix(Delta_disc, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time))
dim(color) <- dim(matrix(Delta_disc, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)))

fig_disc <- plot_ly(x=dim1*(max_impl_vol-min_impl_vol)+min_impl_vol, y=dim2*(max_time-min_time)+min_time, z=matrix(Delta_disc, length(dim1*(max_impl_vol-min_impl_vol)+min_impl_vol), length(dim2*(max_time-min_time)+min_time)), type='surface',surfacecolor=color,
        colors=c('yellow','red'))
fig_disc <- fig_disc %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_disc <- fig_disc %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Implied Volatility'), yaxis = list(title='Time to Expiration'), zaxis= list(title='Delta Discrepancy'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_disc
```

5-3: Contour Plots of Strike Price and Implied Volatility

```{r contour plots_rates_time}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 15)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 15)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 15)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 15)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,1],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,2],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

BS_Delta_cont <- greeks(bsput(s=as.numeric(x2_cont[,1]), k=as.numeric(x2_cont[,2]), v=as.numeric(x2_cont[,3]), r=as.numeric(x2_cont[,6]), tt=as.numeric(x2_cont[,4]), d=as.numeric(x2_cont[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

vector_c_values_cont <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_cont_bs,iter=1, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_c_values_cont <- extract(vector_c_values_cont,permuted=FALSE)
exp_vector_c_values_cont <- c(colMeans(exp_vector_c_values_cont))
exp_vector_c_values_cont <- exp_vector_c_values_cont[1:(length(exp_vector_c_values_cont)-1)]


vector_k_values_cont <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_cont_bs,iter=1, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_k_values_cont <- extract(vector_k_values_cont,permuted=FALSE)
exp_vector_k_values_cont <- c(colMeans(exp_vector_k_values_cont))
exp_vector_k_values_cont <- exp_vector_k_values_cont[1:(length(exp_vector_k_values_cont)-1)]


vector_k_cont <- matrix(exp_vector_k_values_cont, nrow(x2_cont), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta_cont <- BS_Delta_cont + vector_k_cont %*% exp_vector_c_values_cont

Delta_disc <- BSGP_Delta_cont - BS_Delta_cont

color <- matrix(BSGP_Delta_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(BSGP_Delta_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_bs <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(BSGP_Delta_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_bs <- fig_bs %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_bs <- fig_bs %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied Volatility'), zaxis= list(title='Delta'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_bs


color <- matrix(BS_Delta_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(BS_Delta_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_blackscholes <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(BS_Delta_cont, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('blue','red'))
fig_blackscholes <- fig_blackscholes %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_blackscholes <- fig_blackscholes %>% layout(title = 'Black-Scholes', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied Volatility'), zaxis= list(title='Delta'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_blackscholes


##Delta Discrepancies

color <- matrix(Delta_disc, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol))
dim(color) <- dim(matrix(Delta_disc, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)))

fig_disc <- plot_ly(x=dim1*(max_strike-min_strike)+min_strike, y=dim2*(max_impl_vol-min_impl_vol)+min_impl_vol, z=matrix(Delta_disc, length(dim1*(max_strike-min_strike)+min_strike), length(dim2*(max_impl_vol-min_impl_vol)+min_impl_vol)), type='surface',surfacecolor=color,
        colors=c('yellow','red'))
fig_disc <- fig_disc %>% add_surface(showscale = FALSE,contours = list(
  z = list(
    show=TRUE,
    usecolormap=FALSE,
    highlightcolor = "#ff0000",
    project=list(z=TRUE)
  )
))

fig_disc <- fig_disc %>% layout(title = 'BSGP', 
  scene = list(xaxis = list(title='Strike Price'), yaxis = list(title='Implied Volatility'), zaxis= list(title='Delta Discrepancy'),camera = list(
    eye=list(x=-1.25,y=-1.25,z=1.25)
  )
  )
)

fig_disc
```








9-1 Computing Actual Delta for the next day

```{r}
#6/3 ~ 6/7 training + 6/10 test and hedge for 6/11

test_start_backtest_1 <- 323 #Start of 06/10 Puts
test_end_backtest_1 <- 393 # End of 06/10 Puts


# tmr_options_1 <- stan_dat$total_puts_American[tmr_start_backtest_1:tmr_end_backtest_1,]
# today_options_1 <- stan_dat$total_puts_American[test_start_backtest_1:test_end_backtest_1,]
```

```{r}
#filtering out options that are present both today and tmr
# tmr_data_1 <- stan_dat$total_puts_American$optionid[tmr_start_backtest_1:tmr_end_backtest_1]
# today_data_1 <- stan_dat$total_puts_American$optionid[test_start_backtest_1:test_end_backtest_1]

# IDs_1<- unique(today_data_1[today_data_1%in%tmr_data_1])
```

9-2 Generating BSGP prices for Backtesting

```{r Backtest-Setting test to today}

x_1_backtest_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_2_backtest_1 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_3_backtest_1 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest_1:test_end_backtest_1])
x_4_backtest_1 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest_1:test_end_backtest_1])
x_5_backtest_1 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest_1:test_end_backtest_1])
x_6_backtest_1 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest_1:test_end_backtest_1])
x2_backtest_1 <- cbind(x_1_backtest_1,x_2_backtest_1,x_3_backtest_1,x_4_backtest_1,x_5_backtest_1,x_6_backtest_1)

```

```{r computing blackscholes for backtest}

library('qrmtools')
library('ragtop')

x2_bs_backtest_1 <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest_1:test_end_backtest_1]))

blackscholes_test_backtest_1 <- rep(NA,length(x2_bs_backtest_1[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_1))){
  blackscholes_test_backtest_1[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest_1[row,1]),K=as.numeric(x2_bs_backtest_1[row,2]),r=as.numeric(x2_bs_backtest_1[row,6]),t=as.numeric(x2_bs_backtest_1[row,4]),vola=as.numeric(x2_bs_backtest_1[row,3]),divrate=as.numeric(x2_bs_backtest_1[row,5]))$Price)
}

```

```{r Predictions_Backtest to predict for today}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)

post_data_bs_American_backtest_1 <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_backtest_1,N1=length(stan_dat$x[,1]),N2=length(x2_backtest_1[,1]), bs = blackscholes_test_backtest_1,variables = 6)
# post_data

pred_gp_bs_backtest_1 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

```

```{r Mean & SD of Predictions_bs}
#Computing Mean
y_predict_values_bs_backtest_1 <- extract(pred_gp_bs_backtest_1,permuted=FALSE)
y_mean_values_bs_backtest_1 <- c(colMeans(y_predict_values_bs_backtest_1))
y_mean_values_bs_backtest_1 <- y_mean_values_bs_backtest_1[1:(length(y_mean_values_bs_backtest_1)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_1 <- summary(pred_gp_bs_backtest_1, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_1 <- pred_gp_summary_bs_backtest_1[, c("sd")]
y_sd_values_bs_backtest_1 <- pred_gp_sd_bs_backtest_1[1:(length(pred_gp_sd_bs_backtest_1)-1)]
```

```{r predictive performance of backtest price for today}
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_1),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_1:test_end_backtest_1])))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest_1,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_1:test_end_backtest_1]))
```

9-3 Computing BS Delta

```{r compute BSGP delta}
library(derivmkts)
BS_Delta_1 <- greeks(bsput(s=as.numeric(x2_bs_backtest_1[,1]), k=as.numeric(x2_bs_backtest_1[,2]), v=as.numeric(x2_bs_backtest_1[,3]), r=as.numeric(x2_bs_backtest_1[,6]), tt=as.numeric(x2_bs_backtest_1[,4]), d=as.numeric(x2_bs_backtest_1[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_1

```

9-4 Computing BSGP vector C & vector K'

```{r}
vector_c_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_c_values_1 <- extract(vector_c_values_1,permuted=FALSE)
exp_vector_c_values_1 <- c(colMeans(exp_vector_c_values_1))
exp_vector_c_values_1 <- exp_vector_c_values_1[1:(length(exp_vector_c_values_1)-1)]


vector_k_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_k_values_1 <- extract(vector_k_values_1,permuted=FALSE)
exp_vector_k_values_1 <- c(colMeans(exp_vector_k_values_1))
exp_vector_k_values_1 <- exp_vector_k_values_1[1:(length(exp_vector_k_values_1)-1)]


vector_k_1 <- matrix(exp_vector_k_values_1, nrow(x2_backtest_1), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta_1 <- BS_Delta_1 + vector_k_1 %*% exp_vector_c_values_1
```

9-5 Choosing which options to use

```{r}
delta_data <- as.data.frame(cbind(BSGP_Delta_1,y_sd_values_bs_backtest_1))

delta_data <- delta_data[order(y_sd_values_bs_backtest_1),]

ggplot(mapping=aes(x=BSGP_Delta_1,y=BS_Delta_1, color = y_sd_values_bs_backtest_1)) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

hist(y_sd_values_bs_backtest_1)

delta_data_top10 <- delta_data[1,]
top10_options <- rownames(delta_data_top10)


library(unglue)
total_delta_BSGP <- sum(delta_data_top10$V1)

total_delta_BS <- sum(BS_Delta_1[unglue_vec(top10_options, "y_predict[{x}]", convert=TRUE)])
```

```{r}
SPY <- read_csv("SPY.csv")
SPY <- SPY %>% 
  select(Date,Close)

hedge_price <- SPY$Close[SPY$Date == '2019-06-10']
hedge_price_BSGP <- hedge_price * total_delta_BSGP
hedge_price_BS <- hedge_price * total_delta_BS

tmr_price <- SPY$Close[7:nrow(SPY)]

profit_overnight_BSGP <- c()
profit_overnight_BS <- c()

for (price in tmr_price){
  profit_overnight_BSGP <- c(profit_overnight_BSGP,(price-hedge_price)*abs(total_delta_BSGP))
  profit_overnight_BS <- c(profit_overnight_BS,(price-hedge_price)*abs(total_delta_BS))
}


mean(profit_overnight_BS)
mean(profit_overnight_BSGP)

# (tmr_price-hedge_price)*abs(total_delta_BSGP)
# (tmr_price-hedge_price)*abs(total_delta_BS)

potential_stock_price_overnight <- seq(hedge_price*0.99,hedge_price*1.01, by=0.1)

potential_profit_overnight_BSGP <- c()
for (potential_price in potential_stock_price_overnight){
  potential_profit_overnight_BSGP <- c(potential_profit_overnight_BSGP,(potential_price - hedge_price)*abs(total_delta_BSGP))
}

potential_profit_overnight_BS <- c()
for (potential_price in potential_stock_price_overnight){
  potential_profit_overnight_BS <- c(potential_profit_overnight_BS,(potential_price - hedge_price)*abs(total_delta_BS))
}

ggplot() +
  geom_point(aes(x=as.Date(SPY$Date[7:nrow(SPY)]), y=profit_overnight_BSGP), colour = "blue") +
  geom_point(aes(x=as.Date(SPY$Date[7:nrow(SPY)]), y=profit_overnight_BS), colour = "red")


ggplot() +
  geom_point(aes(x=potential_stock_price_overnight, y=potential_profit_overnight_BSGP), colour = "blue") +
  geom_point(aes(x=potential_stock_price_overnight, y=potential_profit_overnight_BS), colour = "red")

```

##SAMPLE 2 for Delta-hedging

```{r}
stan_dat <- read_rdump('Financial_Data_Put_American_2.R')
fit_gp_bs_American <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_bs_American, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American <- extract(fit_gp_bs_American,permuted=FALSE)

post_mean_theta_1_bs <- mean(sum_gp_bs_American[,1,1]) #theta
post_mean_theta_2_bs <- mean(sum_gp_bs_American[,1,2]) #theta
post_mean_theta_3_bs <- mean(sum_gp_bs_American[,1,3]) #theta
post_mean_theta_4_bs <- mean(sum_gp_bs_American[,1,4]) #theta
post_mean_theta_5_bs <- mean(sum_gp_bs_American[,1,5]) #theta
post_mean_theta_6_bs <- mean(sum_gp_bs_American[,1,6]) #theta
post_mean_sigma2_bs <- mean(sum_gp_bs_American[,1,7]) #sigma2
post_mean_gamma2_bs <- mean(sum_gp_bs_American[,1,8]) #gamma2
post_mean_mu_bs <- stan_dat$blackscholes

test_start <- 560 #06/17 Puts
test_end <- 852 #06/20 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
x2 <- cbind(x_1,x_2,x_3,x_4,x_5,x_6)

x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))


library('qrmtools')
library('ragtop')
blackscholes_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
}

post_data_bs_American <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_bs <- extract(pred_gp_bs,permuted=FALSE)
y_mean_values_bs <- c(colMeans(y_predict_values_bs))
y_mean_values_bs <- y_mean_values_bs[1:(length(y_mean_values_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_bs <- summary(pred_gp_bs, sd=c("sd"))$summary
pred_gp_sd_bs <- pred_gp_summary_bs[, c("sd")]
y_sd_values_bs <- pred_gp_sd_bs[1:(length(pred_gp_sd_bs)-1)]
```

```{r predictive performance of backtest price for today}
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_1),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_1:test_end_backtest_1])))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest_1,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_1:test_end_backtest_1]))
```


9-1 Computing Actual Delta for the next day

```{r}
#6/3 ~ 6/7 training + 6/10 test and hedge for 6/11
test_start_backtest_1 <- 560 #Start of 06/10 Puts
test_end_backtest_1 <- 580 # End of 06/10 Puts

```

9-2 Generating BSGP prices for Backtesting

```{r Backtest-Setting test to today}

x_1_backtest_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_2_backtest_1 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_3_backtest_1 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest_1:test_end_backtest_1])
x_4_backtest_1 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest_1:test_end_backtest_1])
x_5_backtest_1 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest_1:test_end_backtest_1])
x_6_backtest_1 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest_1:test_end_backtest_1])
x2_backtest_1 <- cbind(x_1_backtest_1,x_2_backtest_1,x_3_backtest_1,x_4_backtest_1,x_5_backtest_1,x_6_backtest_1)

```

```{r computing blackscholes for backtest}

library('qrmtools')
library('ragtop')

x2_bs_backtest_1 <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest_1:test_end_backtest_1]))

blackscholes_test_backtest_1 <- rep(NA,length(x2_bs_backtest_1[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_1))){
  blackscholes_test_backtest_1[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest_1[row,1]),K=as.numeric(x2_bs_backtest_1[row,2]),r=as.numeric(x2_bs_backtest_1[row,6]),t=as.numeric(x2_bs_backtest_1[row,4]),vola=as.numeric(x2_bs_backtest_1[row,3]),divrate=as.numeric(x2_bs_backtest_1[row,5]))$Price)
}

```

```{r Predictions_Backtest to predict for today}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)

post_data_bs_American_backtest_1 <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_backtest_1,N1=length(stan_dat$x[,1]),N2=length(x2_backtest_1[,1]), bs = blackscholes_test_backtest_1,variables = 6)
# post_data

pred_gp_bs_backtest_1 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

```

```{r Mean & SD of Predictions_bs}
#Computing Mean
y_predict_values_bs_backtest_1 <- extract(pred_gp_bs_backtest_1,permuted=FALSE)
y_mean_values_bs_backtest_1 <- c(colMeans(y_predict_values_bs_backtest_1))
y_mean_values_bs_backtest_1 <- y_mean_values_bs_backtest_1[1:(length(y_mean_values_bs_backtest_1)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_1 <- summary(pred_gp_bs_backtest_1, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_1 <- pred_gp_summary_bs_backtest_1[, c("sd")]
y_sd_values_bs_backtest_1 <- pred_gp_sd_bs_backtest_1[1:(length(pred_gp_sd_bs_backtest_1)-1)]
```

```{r compute BSGP delta}
library(derivmkts)
BS_Delta_1 <- greeks(bsput(s=as.numeric(x2_bs_backtest_1[,1]), k=as.numeric(x2_bs_backtest_1[,2]), v=as.numeric(x2_bs_backtest_1[,3]), r=as.numeric(x2_bs_backtest_1[,6]), tt=as.numeric(x2_bs_backtest_1[,4]), d=as.numeric(x2_bs_backtest_1[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_1

```

9-4 Computing BSGP vector C & vector K'

```{r}
vector_c_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_c_values_1 <- extract(vector_c_values_1,permuted=FALSE)
exp_vector_c_values_1 <- c(colMeans(exp_vector_c_values_1))
exp_vector_c_values_1 <- exp_vector_c_values_1[1:(length(exp_vector_c_values_1)-1)]


vector_k_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_k_values_1 <- extract(vector_k_values_1,permuted=FALSE)
exp_vector_k_values_1 <- c(colMeans(exp_vector_k_values_1))
exp_vector_k_values_1 <- exp_vector_k_values_1[1:(length(exp_vector_k_values_1)-1)]


vector_k_1 <- matrix(exp_vector_k_values_1, nrow(x2_backtest_1), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta_1 <- BS_Delta_1 + vector_k_1 %*% exp_vector_c_values_1
```

9-5 Choosing which options to use

```{r}
delta_data <- as.data.frame(cbind(BSGP_Delta_1,y_sd_values_bs_backtest_1))

delta_data <- delta_data[order(y_sd_values_bs_backtest_1),]

ggplot(mapping=aes(x=BSGP_Delta_1,y=BS_Delta_1, color = y_sd_values_bs_backtest_1)) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

hist(y_sd_values_bs_backtest_1)

delta_data_top10 <- delta_data[1,]
top10_options <- rownames(delta_data_top10)


library(unglue)
unglue_vec(top10_options, "y_predict[{x}]", convert=TRUE)
total_delta_BSGP <- sum(delta_data_top10$V1)

total_delta_BS <- sum(BS_Delta_1[unglue_vec(top10_options, "y_predict[{x}]", convert=TRUE)])
```

```{r}
SPY <- read_csv("SPY.csv")
SPY <- SPY %>% 
  select(Date,Close)

hedge_price <- SPY$Close[SPY$Date == '2019-06-17']
hedge_price_BSGP <- hedge_price * total_delta_BSGP
hedge_price_BS <- hedge_price * total_delta_BS

tmr_price <- SPY$Close[11:nrow(SPY)]

profit_overnight_BSGP <- c()
profit_overnight_BS <- c()

for (price in tmr_price){
  profit_overnight_BSGP <- c(profit_overnight_BSGP,(price-hedge_price)*abs(total_delta_BSGP))
  profit_overnight_BS <- c(profit_overnight_BS,(price-hedge_price)*abs(total_delta_BS))
}

plot(profit_overnight_BS)
plot(profit_overnight_BSGP)
mean(profit_overnight_BS)
mean(profit_overnight_BSGP)

# (tmr_price-hedge_price)*abs(total_delta_BSGP)
# (tmr_price-hedge_price)*abs(total_delta_BS)

potential_stock_price_overnight <- seq(hedge_price*0.99,hedge_price*1.01, by=0.1)

potential_profit_overnight_BSGP <- c()
for (potential_price in potential_stock_price_overnight){
  potential_profit_overnight_BSGP <- c(potential_profit_overnight_BSGP,(potential_price - hedge_price)*abs(total_delta_BSGP))
}

potential_profit_overnight_BS <- c()
for (potential_price in potential_stock_price_overnight){
  potential_profit_overnight_BS <- c(potential_profit_overnight_BS,(potential_price - hedge_price)*abs(total_delta_BS))
}


ggplot() +
  geom_point(aes(x=as.Date(SPY$Date[11:nrow(SPY)]), y=profit_overnight_BSGP), colour = "blue") +
  geom_point(aes(x=as.Date(SPY$Date[11:nrow(SPY)]), y=profit_overnight_BS), colour = "red")

ggplot() +
  geom_point(aes(x=potential_stock_price_overnight, y=potential_profit_overnight_BSGP), colour = "blue") +
  geom_point(aes(x=potential_stock_price_overnight, y=potential_profit_overnight_BS), colour = "red")

```

##Sample 3 for delta hedging - Calls

```{r}
stan_dat <- read_rdump('Financial_Data_Call_American.R')
fit_gp_bs_American <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_bs_American, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American <- extract(fit_gp_bs_American,permuted=FALSE)

post_mean_theta_1_bs <- mean(sum_gp_bs_American[,1,1]) #theta
post_mean_theta_2_bs <- mean(sum_gp_bs_American[,1,2]) #theta
post_mean_theta_3_bs <- mean(sum_gp_bs_American[,1,3]) #theta
post_mean_theta_4_bs <- mean(sum_gp_bs_American[,1,4]) #theta
post_mean_theta_5_bs <- mean(sum_gp_bs_American[,1,5]) #theta
post_mean_theta_6_bs <- mean(sum_gp_bs_American[,1,6]) #theta
post_mean_sigma2_bs <- mean(sum_gp_bs_American[,1,7]) #sigma2
post_mean_gamma2_bs <- mean(sum_gp_bs_American[,1,8]) #gamma2
post_mean_mu_bs <- stan_dat$blackscholes

test_start <- 609 #06/10 Calls
test_end <- 999 #06/14 Calls

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_calls_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_calls_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_calls_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_calls_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_calls_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_calls_American$interest_rate_scaled[test_start:test_end])
x2 <- cbind(x_1,x_2,x_3,x_4,x_5,x_6)

x2_bs <- cbind(as.numeric(stan_dat$total_calls_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_calls_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_calls_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_calls_American$time_to_exp[test_start:test_end]), as.numeric(stan_dat$total_calls_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_calls_American$interest_rate[test_start:test_end]))


library('qrmtools')
library('ragtop')
blackscholes_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(1,S0=as.numeric(stan_dat$total_calls_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_calls_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_calls_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_calls_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_calls_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_calls_American$dividend_yield[test_start:test_end])[row])$Price)
}

post_data_bs_American <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_bs <- extract(pred_gp_bs,permuted=FALSE)
y_mean_values_bs <- c(colMeans(y_predict_values_bs))
y_mean_values_bs <- y_mean_values_bs[1:(length(y_mean_values_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_bs <- summary(pred_gp_bs, sd=c("sd"))$summary
pred_gp_sd_bs <- pred_gp_summary_bs[, c("sd")]
y_sd_values_bs <- pred_gp_sd_bs[1:(length(pred_gp_sd_bs)-1)]
```


9-1 Computing Actual Delta for the next day

```{r}
#6/3 ~ 6/7 training + 6/10 test and hedge for 6/11

test_start_backtest_1 <- 609 #Start of 06/10 Calls
test_end_backtest_1 <- 721 # End of 06/10 Calls

```

9-2 Generating BSGP prices for Backtesting

```{r Backtest-Setting test to today}

x_1_backtest_1 <- as.numeric(stan_dat$total_calls_American$forward_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_2_backtest_1 <- as.numeric(stan_dat$total_calls_American$strike_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_3_backtest_1 <- as.numeric(stan_dat$total_calls_American$impl_volatility_scaled[test_start_backtest_1:test_end_backtest_1])
x_4_backtest_1 <- as.numeric(stan_dat$total_calls_American$time_to_exp_scaled[test_start_backtest_1:test_end_backtest_1])
x_5_backtest_1 <- as.numeric(stan_dat$total_calls_American$dividend_yield_scaled[test_start_backtest_1:test_end_backtest_1])
x_6_backtest_1 <- as.numeric(stan_dat$total_calls_American$interest_rate_scaled[test_start_backtest_1:test_end_backtest_1])
x2_backtest_1 <- cbind(x_1_backtest_1,x_2_backtest_1,x_3_backtest_1,x_4_backtest_1,x_5_backtest_1,x_6_backtest_1)

```

```{r computing blackscholes for backtest}

library('qrmtools')
library('ragtop')

x2_bs_backtest_1 <- cbind(as.numeric(stan_dat$total_calls_American$forward_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_calls_American$strike_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_calls_American$impl_volatility[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_calls_American$time_to_exp[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_calls_American$dividend_yield[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_calls_American$interest_rate[test_start_backtest_1:test_end_backtest_1]))

blackscholes_test_backtest_1 <- rep(NA,length(x2_bs_backtest_1[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_1))){
  blackscholes_test_backtest_1[row] <- as.numeric(blackscholes(1,S0=as.numeric(x2_bs_backtest_1[row,1]),K=as.numeric(x2_bs_backtest_1[row,2]),r=as.numeric(x2_bs_backtest_1[row,6]),t=as.numeric(x2_bs_backtest_1[row,4]),vola=as.numeric(x2_bs_backtest_1[row,3]),divrate=as.numeric(x2_bs_backtest_1[row,5]))$Price)
}

```

```{r Predictions_Backtest to predict for today}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)

post_data_bs_American_backtest_1 <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_backtest_1,N1=length(stan_dat$x[,1]),N2=length(x2_backtest_1[,1]), bs = blackscholes_test_backtest_1,variables = 6)
# post_data

pred_gp_bs_backtest_1 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

```

```{r Mean & SD of Predictions_bs}
#Computing Mean
y_predict_values_bs_backtest_1 <- extract(pred_gp_bs_backtest_1,permuted=FALSE)
y_mean_values_bs_backtest_1 <- c(colMeans(y_predict_values_bs_backtest_1))
y_mean_values_bs_backtest_1 <- y_mean_values_bs_backtest_1[1:(length(y_mean_values_bs_backtest_1)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_1 <- summary(pred_gp_bs_backtest_1, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_1 <- pred_gp_summary_bs_backtest_1[, c("sd")]
y_sd_values_bs_backtest_1 <- pred_gp_sd_bs_backtest_1[1:(length(pred_gp_sd_bs_backtest_1)-1)]
```

```{r predictive performance of backtest price for today}
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_1),y=log(cbind(stan_dat$total_calls_American$mid_price[test_start_backtest_1:test_end_backtest_1])))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

ggplot(mapping=aes(x=log(blackscholes_test_backtest_1),y=log(cbind(stan_dat$total_calls_American$mid_price[test_start_backtest_1:test_end_backtest_1])))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)
MSE(y_mean_values_bs_backtest_1,cbind(stan_dat$total_calls_American$mid_price[test_start_backtest_1:test_end_backtest_1]))
MSE(blackscholes_test_backtest_1,cbind(stan_dat$total_calls_American$mid_price[test_start_backtest_1:test_end_backtest_1]))
```

9-3 Computing BS Delta

```{r compute BSGP delta}
library(derivmkts)
BS_Delta_1 <- greeks(bscall(s=as.numeric(x2_bs_backtest_1[,1]), k=as.numeric(x2_bs_backtest_1[,2]), v=as.numeric(x2_bs_backtest_1[,3]), r=as.numeric(x2_bs_backtest_1[,6]), tt=as.numeric(x2_bs_backtest_1[,4]), d=as.numeric(x2_bs_backtest_1[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_1

```

9-4 Computing BSGP vector C & vector K'

```{r}
vector_c_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_c_values_1 <- extract(vector_c_values_1,permuted=FALSE)
exp_vector_c_values_1 <- c(colMeans(exp_vector_c_values_1))
exp_vector_c_values_1 <- exp_vector_c_values_1[1:(length(exp_vector_c_values_1)-1)]


vector_k_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

exp_vector_k_values_1 <- extract(vector_k_values_1,permuted=FALSE)
exp_vector_k_values_1 <- c(colMeans(exp_vector_k_values_1))
exp_vector_k_values_1 <- exp_vector_k_values_1[1:(length(exp_vector_k_values_1)-1)]


vector_k_1 <- matrix(exp_vector_k_values_1, nrow(x2_backtest_1), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta_1 <- BS_Delta_1 + vector_k_1 %*% exp_vector_c_values_1
```

9-5 Choosing which options to use

```{r}
delta_data <- as.data.frame(cbind(BSGP_Delta_1,y_sd_values_bs_backtest_1))

delta_data <- delta_data[order(y_sd_values_bs_backtest_1),]

ggplot(mapping=aes(x=BSGP_Delta_1,y=BS_Delta_1, color = y_sd_values_bs_backtest_1)) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

hist(y_sd_values_bs_backtest_1)

delta_data_top10 <- delta_data[1,]
top10_options <- rownames(delta_data_top10)


library(unglue)
unglue_vec(top10_options, "y_predict[{x}]", convert=TRUE)
total_delta_BSGP <- sum(delta_data_top10$V1)

total_delta_BS <- sum(BS_Delta_1[unglue_vec(top10_options, "y_predict[{x}]", convert=TRUE)])
```

```{r}
# SPY <- read_csv("SPY.csv")
# SPY <- SPY %>% 
#   select(Date,Close)
# 
# hedge_price <- SPY$Close[SPY$Date == '2019-06-10']
# hedge_price_BSGP <- hedge_price * total_delta_BSGP
# hedge_price_BS <- hedge_price * total_delta_BS
# 
# tmr_price <- SPY$Close[7:nrow(SPY)]
# 
# profit_overnight_BSGP <- c()
# profit_overnight_BS <- c()
# 
# for (price in tmr_price){
#   profit_overnight_BSGP <- c(profit_overnight_BSGP,(price-hedge_price)*abs(total_delta_BSGP))
#   profit_overnight_BS <- c(profit_overnight_BS,(price-hedge_price)*abs(total_delta_BS))
# }
# 
# 
# mean(profit_overnight_BS)
# mean(profit_overnight_BSGP)
# 
# # (tmr_price-hedge_price)*abs(total_delta_BSGP)
# # (tmr_price-hedge_price)*abs(total_delta_BS)
# 
# potential_stock_price_overnight <- seq(hedge_price*0.99,hedge_price*1.01, by=0.1)
# 
# potential_profit_overnight_BSGP <- c()
# for (potential_price in potential_stock_price_overnight){
#   potential_profit_overnight_BSGP <- c(potential_profit_overnight_BSGP,(potential_price - hedge_price)*abs(total_delta_BSGP))
# }
# 
# potential_profit_overnight_BS <- c()
# for (potential_price in potential_stock_price_overnight){
#   potential_profit_overnight_BS <- c(potential_profit_overnight_BS,(potential_price - hedge_price)*abs(total_delta_BS))
# }
# 
# ggplot() +
#   geom_point(aes(x=as.Date(SPY$Date[11:nrow(SPY)]), y=profit_overnight_BSGP), colour = "blue") +
#   geom_point(aes(x=as.Date(SPY$Date[11:nrow(SPY)]), y=profit_overnight_BS), colour = "red")
# 
# 
# ggplot() +
#   geom_point(aes(x=potential_stock_price_overnight, y=potential_profit_overnight_BSGP), colour = "blue") +
#   geom_point(aes(x=potential_stock_price_overnight, y=potential_profit_overnight_BS), colour = "red")

```

10.Learning the Influence Coefficient

10-1 Distribution of Influence Coefficient

```{r}
DAD <- abs(unlist(vector_k_1 %*% exp_vector_c_values_1))

IC <- abs(exp_vector_c_values_1)

ggplot(mapping = aes(x=DAD)) + geom_histogram()+
  labs(title = "Distribution of Influence Coefficient",
       x = "Values of Influence Coefficient",
       y = "Frequency") +
  theme_bw() +
  theme(text=element_text(size=16))

# High_DAD <- c()
# for (number in IC){
#   if (number > unname(quantile(IC)[4])){
#     High_DAD <- append(High_DAD,number)
#   }
# }
# 
# Low_DAD <- c()
# for (number in IC){
#   if (number < unname(quantile(IC)[2])){
#     Low_DAD <- append(Low_DAD,number)
#   }
# }

Lowest_DAD <- c()
Low_DAD <- c()
High_DAD <- c()
Highest_DAD <- c()

for (number in DAD){
  if (number < unname(quantile(DAD)[2])){
    Lowest_DAD <- append(Lowest_DAD,number)
  }
  else if (number < unname(quantile(DAD)[3])){
    Low_DAD <- append(Low_DAD, number)
  }
  else if (number < unname(quantile(DAD)[4])){
    High_DAD <- append(High_DAD, number)
  }
  else {
    Highest_DAD <- append(Highest_DAD, number)
  }
}
Lowest_DAD
Low_DAD
High_DAD
Highest_DAD

Highest_data <- stan_dat$x[match(Highest_DAD, DAD),]
Highest_data <- as.data.frame(Highest_data)
Highest_data$DAD <- "Highest_DAD"

High_data <- stan_dat$x[match(High_DAD, DAD),]
High_data <- as.data.frame(High_data)
High_data$DAD <-"High_DAD"

Low_data <- stan_dat$x[match(Low_DAD, DAD),]
Low_data <- as.data.frame(Low_data)
Low_data$DAD <- "Low_DAD"

Lowest_data <- stan_dat$x[match(Lowest_DAD, DAD),]
Lowest_data <- as.data.frame(Lowest_data)
Lowest_data$DAD <- "Lowest_DAD"

DAD_data <- rbind(Highest_data, High_data, Low_data, Lowest_data)
DAD_data <- DAD_data %>% 
  rename(
    Spot_Price = x_1,
    Strike_Price = x_2,
    Implied_Volatility = x_3,
    Time_to_Expiration = x_4,
    Dividend_Yield = x_5,
    Interest_Rate = x_6
  )
DAD_data$DAD <- as.factor(DAD_data$DAD)

# High_DAD_data <- stan_dat$x[match(High_DAD,IC),]
# Low_DAD_data <- stan_dat$x[match(Low_DAD,IC),]
# DAD_data <- rbind(High_DAD_data,Low_DAD_data) 
# DAD_values <- c(rep(1,times=length(High_DAD)), rep(0,times=length(Low_DAD)))
# 
# Training_option_price <- append(stan_dat$y[match(High_DAD,IC)], stan_dat$y[match(Low_DAD,IC)])
Training_option_price <- stan_dat$y

```

1) Simple Classification Tree

```{r}
library(tree)

tree.DAD <- tree(DAD ~ ., DAD_data)
summary(tree.DAD)
plot(tree.DAD)
text(tree.DAD, pretty = 0)
tree.DAD
```

2) Pruned Tree

```{r}
set.seed(3)
cv.DAD <- cv.tree(tree.DAD, FUN = prune.misclass)
names(cv.DAD)
cv.DAD

par(mfrow = c(1,2))
plot(cv.DAD$size, cv.DAD$dev, type = "b")
plot(cv.DAD$k, cv.DAD$dev, type = "b")

prune.DAD <- prune.misclass(tree.DAD, best = 4)
plot(prune.DAD)
text(prune.DAD, pretty = 0)

0.7503*(max(stan_dat$total_puts_American$impl_volatility)-min(stan_dat$total_puts_American$impl_volatility))+min(stan_dat$total_puts_American$impl_volatility)
```

3) Bagging 

```{r}
library(randomForest)
set.seed(1)
bag.DAD <- randomForest(DAD ~ ., data = DAD_data, mtry = 6, importance = TRUE, ntree=25)
bag.DAD

importance(bag.DAD)
varImpPlot(bag.DAD)
```

4) Random Forest

```{r}
set.seed(6)
rf.DAD <- randomForest(DAD ~ ., data = DAD_data, mtry = 2, importance = TRUE)
rf.DAD

importance(rf.DAD)
varImpPlot(rf.DAD)

```



Try out decision tree/classification tree after dividing the DADs into two groups "High DAD" & "Low DAD" by median, maybe even random forest or more -> trying to visualize where the data is influential

10-2 Color Coded Map of Influence Coefficient

```{r}
x.grid_1_cont <- DAD_data$Spot_Price
x.grid_2_cont <- DAD_data$Strike_Price

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)

col.pal<-colorRampPalette(c("red", "green"))
colors<-col.pal(100)
z <- matrix(DAD_data$DAD, length(dim1), length(dim2))

# height of facets
z.facet.center <- (z[-1, -1] + z[-1, -ncol(z)] + z[-nrow(z), -1] + z[-nrow(z), -ncol(z)])/4
# Range of the facet center on a 100-scale (number of colors)
z.facet.range<-cut(z.facet.center, 100)

persp(dim1, dim2, z, phi = 45, theta = 45, border="grey80",col=colors[z.facet.range],shade=0.4,expand=0.4, nticks = 2,ticktype="detailed", xlab="Spot Price", ylab = "Strike Price", zlab = "DAD", main = "DAD Values (Strike Price & Impl_vol)")

x.grid_1_cont <- DAD_data$Spot_Price
x.grid_2_cont <- DAD_data$Implied_Volatility

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)

z <- matrix(DAD_data$DAD, length(dim1), length(dim2))

# height of facets
z.facet.center <- (z[-1, -1] + z[-1, -ncol(z)] + z[-nrow(z), -1] + z[-nrow(z), -ncol(z)])/4
# Range of the facet center on a 100-scale (number of colors)
z.facet.range<-cut(z.facet.center, 100)

persp(dim1, dim2, z, phi = 45, theta = 45, border="grey80",col=colors[z.facet.range],shade=0.4,expand=0.4, nticks = 2,ticktype="detailed", xlab="Spot Price", ylab = "Implied Volatility", zlab = "DAD", main = "DAD Values (Spot Price & Impl_vol)")

# library(grid)
# grid.newpage()
#Spot vs Strike

DAD_data$DAD <- as.numeric(DAD_data$DAD)

ggplot(DAD_data, mapping=aes(x=Implied_Volatility,y=Dividend_Yield, color = DAD)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Strike",
       x = "Spot Price",
       y = "Strike Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Implied Volatility
ggplot(DAD_data, mapping=aes(x=Spot_Price,y=Implied_Volatility, color = DAD)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Implied Volatility",
       x = "Spot Price",
       y = "Implied Volatility") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Time to Expiration
ggplot(DAD_data, mapping=aes(x=Spot_Price,y=Time_to_Expiration, color = DAD)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Time to Expiration",
       x = "Spot Price",
       y = "Time to Expiration") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Dividend Yield
ggplot(DAD_data, mapping=aes(x=Spot_Price,y=Dividend_Yield, color = DAD)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Dividend Yield",
       x = "Spot Price",
       y = "Dividend Yield") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Interest Rate
ggplot(DAD_data, mapping=aes(x=Spot_Price,y=Interest_Rate, color = DAD)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Interest Rate",
       x = "Spot Price",
       y = "Interest Rate") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Option Price
ggplot(mapping=aes(x=DAD_data$Spot_Price,y=Training_option_price, color = DAD_data$DAD)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Option Price",
       x = "Spot Price",
       y = "Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

```


##Maybe try for 2018 data, or other periods -> prove that the model is robust enough (what is the good amount of training trials to prove it is robust)
##Maybe try 1 year oR monthly rebalancing and compare performance wit hBS delta-hedged portfiolo
#where can swe submit (journal) the delta-hedge paper journal - separate this part into separate overleaf file. 

##delta-hedging -> bs holds unrealistic assumptions which is why the disparity is larger for long-term.

#how to choose whcih options to use for delta hedging (https://en.wikipedia.org/wiki/Multi-armed_bandit)

#change equation 17 and 18 to match notation

#do same process for deltas (computing, predictive uncertainty, DAD)
#Novelty of the model (combines both shitty approaches data-driven and model-driven) -> predicting delta(this is even unobserved)
#include content on this to JBES 
#we can compute sth unobserved in data just with price!!!! AMAZING!!
#Get rid of DAD name

#Morris paper to calculaute predictive uncertainty for delta values

##save data file for stan files



##Things to do

#1. plot formatting
#2. Write-up for deltas
#3. Derivation for delta uncertainty
