---
title: "Gaussian_Process_Code"
author: "Chiwan Kim"
date: "2/3/2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# In order to change to calls -> change the testing and training index numbers, change blackscholes formula (-1,1), change total_puts to total_calls
```

##Part 1: Standard Gaussian Process

1-1: Fitting

```{r Fitting_SGP, warning = FALSE}
library(rstan)
source("gp.utility.R")

# Fitting GP model
stan_dat <- read_rdump('Financial_Data_Put_American.R')
fit_gp_SGP_American <- stan(file="gp-fit-6dimension_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_SGP_American, pars = c('theta','sigma2','gamma2'))
sum_gp_SGP_American <- extract(fit_gp_SGP_American,permuted=FALSE)
```

```{r Computing Means for prediction_SGP}
# Predicting from GP model
post_mean_theta_1_SGP <- mean(sum_gp_SGP_American[,1,1]) #theta
post_mean_theta_2_SGP <- mean(sum_gp_SGP_American[,1,2]) #theta
post_mean_theta_3_SGP <- mean(sum_gp_SGP_American[,1,3]) #theta
post_mean_theta_4_SGP <- mean(sum_gp_SGP_American[,1,4]) #theta
post_mean_theta_5_SGP <- mean(sum_gp_SGP_American[,1,5]) #theta
post_mean_theta_6_SGP <- mean(sum_gp_SGP_American[,1,6]) #theta
post_mean_sigma2_SGP <- mean(sum_gp_SGP_American[,1,7]) #sigma2
post_mean_gamma2_SGP <- mean(sum_gp_SGP_American[,1,8]) #gamma2
post_mean_mu_SGP <- mean(sum_gp_SGP_American[,1,9])


```

```{r Blackscholes and assigning test data-1}
test_start <- 323 #06/10 Puts
test_end <- 559 #06/14 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
x2 <- cbind(x_1,x_2,x_3,x_4,x_5,x_6)
```


```{r computing blackscholes for test}
x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))


library('qrmtools')
library('ragtop')
blackscholes_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
}

```

1-2: Predictions

```{r Predictions_SGP}

post_data_SGP_American <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_SGP_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

##Part2:  BS Integrated SGP

2-1: Fitting

```{r Fitting_Bdrycov,warning = FALSE}
# Fitting GP model for Bdrycov
fit_gp_bs_American <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_bs_American, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American <- extract(fit_gp_bs_American,permuted=FALSE)
```

```{r Computing means for prediction_Bdrycov}
# Predicting from GP model - 2 dimensional case
post_mean_theta_1_bs <- mean(sum_gp_bs_American[,1,1]) #theta
post_mean_theta_2_bs <- mean(sum_gp_bs_American[,1,2]) #theta
post_mean_theta_3_bs <- mean(sum_gp_bs_American[,1,3]) #theta
post_mean_theta_4_bs <- mean(sum_gp_bs_American[,1,4]) #theta
post_mean_theta_5_bs <- mean(sum_gp_bs_American[,1,5]) #theta
post_mean_theta_6_bs <- mean(sum_gp_bs_American[,1,6]) #theta
post_mean_sigma2_bs <- mean(sum_gp_bs_American[,1,7]) #sigma2
post_mean_gamma2_bs <- mean(sum_gp_bs_American[,1,8]) #gamma2
post_mean_mu_bs <- stan_dat$blackscholes
```


2-2: Predictions

```{r Predictions_Bdrycov}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)

post_data_bs_American <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

##Part 3 Predictions Versus Truth

3-1: Computing Means Standard GP

```{r Mean & SD of Predictions_SGP}
#Computing Mean
y_predict_values_SGP <- extract(pred_gp_SGP,permuted=FALSE)
y_mean_values_SGP <- c(colMeans(y_predict_values_SGP))
y_mean_values_SGP <- y_mean_values_SGP[1:(length(y_mean_values_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_SGP <- summary(pred_gp_SGP, sd=c("sd"))$summary
pred_gp_sd_SGP <- pred_gp_summary_SGP[, c("sd")]
y_sd_values_SGP <- pred_gp_sd_SGP[1:(length(pred_gp_sd_SGP)-1)]
```

3-2: Computing Means bs

```{r Mean & SD of Predictions_bs}
#Computing Mean
y_predict_values_bs <- extract(pred_gp_bs,permuted=FALSE)
y_mean_values_bs <- c(colMeans(y_predict_values_bs))
y_mean_values_bs <- y_mean_values_bs[1:(length(y_mean_values_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_bs <- summary(pred_gp_bs, sd=c("sd"))$summary
pred_gp_sd_bs <- pred_gp_summary_bs[, c("sd")]
y_sd_values_bs <- pred_gp_sd_bs[1:(length(pred_gp_sd_bs)-1)]
```

3-3: Plotting Predicted Values against Truth

```{r prediction accuracy}
par(mfrow=c(1,3))
#Plotting Standard GP
ggplot(mapping=aes(x=log(y_mean_values_SGP),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting bs
ggplot(mapping=aes(x=log(y_mean_values_bs),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


#Plotting Blackscholes
ggplot(mapping=aes(x=log(blackscholes_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

#MSE
library('MLmetrics')
MSE(y_mean_values_SGP,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(y_mean_values_bs,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(blackscholes_test,stan_dat$total_puts_American$mid_price[test_start:test_end])
```

##Part 4 MSE over Time

4-1: Plotting MSE over time


```{r}
#MSE
library('MLmetrics')
SGP_MSE_0610 <- MSE(y_mean_values_SGP[1:71],stan_dat$total_puts_American$mid_price[323:393])
SGP_MSE_0611 <- MSE(y_mean_values_SGP[72:143],stan_dat$total_puts_American$mid_price[394:465])
SGP_MSE_0612 <- MSE(y_mean_values_SGP[144:164],stan_dat$total_puts_American$mid_price[466:486])
SGP_MSE_0613 <- MSE(y_mean_values_SGP[165:200],stan_dat$total_puts_American$mid_price[487:522])
SGP_MSE_0614 <- MSE(y_mean_values_SGP[201:237],stan_dat$total_puts_American$mid_price[523:559])
SGP_MSE <- rbind(SGP_MSE_0610,SGP_MSE_0611,SGP_MSE_0612,SGP_MSE_0613,SGP_MSE_0614)

BS_SGP_MSE_0610 <- MSE(y_mean_values_bs[1:71],stan_dat$total_puts_American$mid_price[323:393])
BS_SGP_MSE_0611 <- MSE(y_mean_values_bs[72:143],stan_dat$total_puts_American$mid_price[394:465])
BS_SGP_MSE_0612 <- MSE(y_mean_values_bs[144:164],stan_dat$total_puts_American$mid_price[466:486])
BS_SGP_MSE_0613 <- MSE(y_mean_values_bs[165:200],stan_dat$total_puts_American$mid_price[487:522])
BS_SGP_MSE_0614 <- MSE(y_mean_values_bs[201:237],stan_dat$total_puts_American$mid_price[523:559])
BS_SGP_MSE <- rbind(BS_SGP_MSE_0610,BS_SGP_MSE_0611,BS_SGP_MSE_0612,BS_SGP_MSE_0613,BS_SGP_MSE_0614)

BS_MSE_0610 <- MSE(blackscholes_test[1:71],stan_dat$total_puts_American$mid_price[323:393])
BS_MSE_0611 <- MSE(blackscholes_test[72:143],stan_dat$total_puts_American$mid_price[394:465])
BS_MSE_0612 <- MSE(blackscholes_test[144:164],stan_dat$total_puts_American$mid_price[466:486])
BS_MSE_0613 <- MSE(blackscholes_test[165:200],stan_dat$total_puts_American$mid_price[487:522])
BS_MSE_0614 <- MSE(blackscholes_test[201:237],stan_dat$total_puts_American$mid_price[523:559])
BS_MSE <- rbind(BS_MSE_0610,BS_MSE_0611,BS_MSE_0612,BS_MSE_0613,BS_MSE_0614)

MSE_data <- as.data.frame(rbind(SGP_MSE,BS_SGP_MSE,BS_MSE))

MSE_data$date <- c(as.Date('00/00/0000', format = '%m/%d/%Y'))
MSE_data$date[c(1,6,11)] <- as.Date('06/10/2019', format = '%m/%d/%Y')
MSE_data$date[c(2,7,12)] <- as.Date('06/11/2019', format = '%m/%d/%Y')
MSE_data$date[c(3,8,13)] <- as.Date('06/12/2019', format = '%m/%d/%Y')
MSE_data$date[c(4,9,14)] <- as.Date('06/13/2019', format = '%m/%d/%Y')
MSE_data$date[c(5,10,15)] <- as.Date('06/14/2019', format = '%m/%d/%Y')

MSE_data$Method <- "Method"
MSE_data$Method[1:5] <- "SGP"
MSE_data$Method[6:10] <- "Black-Scholes Integrated_SGP"
MSE_data$Method[11:15] <- "Black-Scholes"

MSE_data <- MSE_data %>% 
  rename(MSE_values = V1)
  
#Plotting Blackscholes
ggplot(data=MSE_data, mapping=aes(x=date, y=MSE_values, colour = Method, shape = Method)) +
  geom_point(size = 2) +
  geom_line() +
  labs(title = "MSE Across Time",
       x = "Date",
       y = "Mean Squared Error") +
  theme_bw() +
  theme(text=element_text(size=16))
```


##Part 5 Interpretations

5-1: Contour Plots of Forward Price & Strike Price

```{r contour plots_forward_strike}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,1],K=x2_cont_bs[row,2],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,3],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
library(base)
persp(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Spot Price", ylab = "Strike Price", zlab = "Average Price", main = "SGP Means (Spot Price & Strike Price)")

#Contour of Variance
persp(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Spot Price", ylab = "Strike Price", zlab = "Standard Deviation", main = "SGP Standard Deviation (Spot Price & Strike Price)")

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BS_GP Means in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Spot Price", ylab = "Strike Price", zlab = "Average Price", main = "BSGP Average Price (Spot Price & Strike Price)")
#Contour of Variance
# contour(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BS_GP Standard Deviation in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Spot Price", ylab = "Strike Price", zlab = "Standard Deviation", main = "BSGP Standard Deviation (Spot Price & Strike Price)")
par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), labcex = 2, main = "Black-Scholes Means in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Spot Price", ylab = "Strike Price", zlab = "Average Price", main = "BlackScholes Average Price (Spot Price & Strike Price)")
#Contour of Variance
# contour(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Standard Deviation in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
# persp(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Spot Price", ylab = "Strike Price", zlab = "Standard Deviation", main = "Blackscholes Standard Deviation (Spot Price & Strike Price)")
```

5-2: Contour Plots of Implied Volatility & Time to Expiration

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,4],r=x2_cont_bs[row,6],t=x2_cont_bs[row,2],vola=x2_cont_bs[row,1],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Implied Volatility", ylab = "Time to Expiration", zlab = "Average Price", main = "SGP Average Price (Impl_vol & Time_to_Exp)")
#Contour of Variance
# contour(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Implied Volatility", ylab = "Time to Expiration", zlab = "Standard Deviation", main = "SGP Standard Deviation (Impl_vol & Time_to_Exp)")

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Implied Volatility", ylab = "Time to Expiration", zlab = "Average Price", main = "BSGP Average Price (Impl_vol & Time_to_Exp)")
#Contour of Variance
# contour(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Standard Deviation in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Implied Volatility", ylab = "Time to Expiration", zlab = "Standard Deviation", main = "BSGP Standard Deviation (Impl_vol & Time_to_Exp)")

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Implied Volatility", ylab = "Time to Expiration", zlab = "Average Price", main = "Blackscholes Average Price (Impl_vol & Time_to_Exp)")
#Contour of Variance
# contour(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Standard Deviation in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
# persp(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Implied Volatility", ylab = "Time to Expiration", zlab = "Standard Deviation", main = "Blackscholes Standard Deviation (Impl_vol & Time_to_Exp)")
```

5-3: Contour Plots of Strike Price and Implied Volatility

```{r contour plots_rates_time}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,1],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,2],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Means in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Strike Price", ylab = "Implied Volatility", zlab = "Average Price", main = "SGP Average Price (Strike Price & Impl_vol)")
#Contour of Variance
# contour(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Standard Deviation in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Strike Price", ylab = "Implied Volatility", zlab = "Standard Deviation", main = "SGP Standard Deviation (Strike Price & Impl_vol)")

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Means in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Strike Price", ylab = "Implied Volatility", zlab = "Average Price", main = "BSGP Average Price (Strike Price & Impl_vol)")
#Contour of Variance
# contour(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Standard Deviation in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Strike Price", ylab = "Implied Volatility", zlab = "Standard Deviation", main = "BSGP Standard Deviation (Strike Price & Impl_vol)")

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
# contour(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Means in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
persp(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Strike Price", ylab = "Implied Volatility", zlab = "Average Price", main = "Blackscholes Average Price (Strike Price & Impl_vol)")
#Contour of Variance
# contour(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Standard Deviation in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
# points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
# persp(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), phi = 45, theta = 45, xlab="Strike Price", ylab = "Implied Volatility", zlab = "Standard Deviation", main = "Blackscholes Standard Deviation (Strike Price & Impl_vol)")
```

## Part 6: Standard Deviation of Predicted Values

6-1: Plotting Standard Deviation of Predictions

```{r}
par(mfrow=c(1,3))
ggplot(mapping = aes(x = seq(1:237),y=y_sd_values_SGP)) + geom_point(size = 2)+
  ylim(0,0.5)+ labs(title = "Standard Deviation of SGP",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

ggplot(mapping = aes(x = seq(1:237),y=y_sd_values_bs)) + geom_point(size = 2)+
  ylim(0,0.5)+
  labs(title = "Standard Deviation of Black-Scholes Integrated SGP",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

ggplot(mapping = aes(x = seq(1:237),y=rep(0,237))) + geom_point(size = 2)+
  ylim(0,0.5)+
  labs(title = "Standard Deviation of Black-Scholes",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

mean(y_sd_values_SGP)
mean(y_sd_values_bs)
mean(0)
```

##Part 7 Discrepancy Modeling

7-1: Computing Discrepancy

```{r}
Discrepancy <- y_mean_values_bs - blackscholes_test

library('MLmetrics')
Discrepnacy_0610 <- mean(Discrepancy[1:71])
Discrepancy_0611 <- mean(Discrepancy[72:143])
Discrepancy_0612 <- mean(Discrepancy[144:164])
Discrepancy_0613 <- mean(Discrepancy[165:200])
Discrepancy_0614 <- mean(Discrepancy[201:237])
Discrepancy_data <- as.data.frame(rbind(SGP_MSE_0610,SGP_MSE_0611,SGP_MSE_0612,SGP_MSE_0613,SGP_MSE_0614))

Discrepancy_data$date <- c(as.Date('00/00/0000', format = '%m/%d/%Y'))
Discrepancy_data$date[1] <- as.Date('06/10/2019', format = '%m/%d/%Y')
Discrepancy_data$date[2] <- as.Date('06/11/2019', format = '%m/%d/%Y')
Discrepancy_data$date[3] <- as.Date('06/12/2019', format = '%m/%d/%Y')
Discrepancy_data$date[4] <- as.Date('06/13/2019', format = '%m/%d/%Y')
Discrepancy_data$date[5] <- as.Date('06/14/2019', format = '%m/%d/%Y')

Discrepancy_data <- Discrepancy_data %>% 
  rename(Discrepancy_values = V1)
  
plot(Discrepancy, main = "Plotting Discrepancy Between BSGP and Black-Scholes", xlab = "Plot Points", ylab = "Discrepancy in $")

#Plotting Blackscholes
ggplot(data=Discrepancy_data, mapping=aes(x=date, y=Discrepancy_values)) +
  geom_point(size = 2) +
  geom_line() +
  labs(title = "Plotting Mean Discrepancy Across Time",
       x = "Date",
       y = "Discrepancy in $") +
  theme_bw() +
  theme(text=element_text(size=16))
```

7-2: Discrepancy Contour Plots of Forward Price & Strike Price 

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,1],K=x2_cont_bs[row,2],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,3],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data


pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(Discrepancy_function, length(dim1), length(dim2)), labcex =1.5, main = "Discrepancy Modeled in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

7-3: Discrepancy Contour Plots of Implied Volatility & Time to Expiration

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,4],r=x2_cont_bs[row,6],t=x2_cont_bs[row,2],vola=x2_cont_bs[row,1],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(Discrepancy_function, length(dim1), length(dim2)), labcex =1.5, main = "Discrepancy Modeling in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

7-4: Discrepancy Contour Plots of Strike Price & Implied Volatility

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,1],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,2],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(Discrepancy_function, length(dim1), length(dim2)), labcex =1.5, main = "Discrepancy Modeling in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

##Part 8: Other Machine Learning Methods

8-1: Fitting ANN

```{r Fitting_ANN}
library(rstan)
source("gp.utility.R")
library(neuralnet)

# Fitting ANN model
stan_dat <- read_rdump('Financial_Data_Put_American.R')
train <- data.frame(stan_dat$train)
n <- names(data.frame(stan_dat$train))
nn <- neuralnet(y_scaled ~ x_1 + x_2 + x_3 + x_4 + x_5 + x_6, data=train, hidden=c(5,3),linear.output=TRUE ,threshold=0.01)
plot(nn)
```

8-2: Testing ANN

```{r Testing_ANN}
#Testing
test_start <- 323 #06/10 Puts
test_end <- 559 #06/14 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
y_scaled <- as.numeric(stan_dat$total_puts_American$mid_price_scaled[test_start:test_end])
test <- data.frame(cbind(x_1,x_2,x_3,x_4,x_5,x_6,y_scaled))


predict_testNN <- neuralnet::compute(nn, test[,c(1:6)])
predict_testNN <- (predict_testNN$net.result * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(stan_dat$total_puts_American$mid_price[test_start:test_end], predict_testNN, col='blue', pch=16, ylab = "predicted price NN", xlab = "real price")
abline(0,1)


MSE(predict_testNN,stan_dat$total_puts_American$mid_price[test_start:test_end])
```

8-3 Fitting & Testing Bagging

```{r Fitting_Random Forest}
#Bagging
library(tree)
library(randomForest)

bagging <- randomForest(y_scaled~., data = train, mtry = 6, importance = TRUE)
bagging

yhat.bag <- predict(bagging, newdata = test)
yhat.bag <- (yhat.bag * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(yhat.bag, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((yhat.bag - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)


#Random Forest
rf <- randomForest(y_scaled~., data = train, mtry = 2, importance = TRUE)
yhat.rf <- predict(rf, newdata = test)
yhat.rf <- (yhat.rf * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(yhat.rf, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((yhat.rf - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)
```

8-4 Fitting & Testing Binomial Option Trees

```{r}
library(derivmkts)

x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))

binom_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  binom_test[row] <- binomopt(s=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],k=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],v=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],tt=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],d=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row], nstep = 6000, american=TRUE, putopt=TRUE)
}

plot(binom_test, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((binom_test - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)
```


8-5 Summary of Other Machine Learning Methods

```{r summary of results for all methods}
par(mfrow=c(2,3))
#Plotting Standard GP
ggplot(mapping=aes(x=log(y_mean_values_SGP),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting bs
ggplot(mapping=aes(x=log(y_mean_values_bs),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


#Plotting Blackscholes
ggplot(mapping=aes(x=log(blackscholes_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

#Plotting Artificial Neural Networks
ggplot(mapping=aes(x=log(predict_testNN),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Neural Network",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Bagging
ggplot(mapping=aes(x=log(yhat.bag),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Bagging",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Random Forest
ggplot(mapping=aes(x=log(yhat.rf),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Random Forest",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Binomial Option Tree
ggplot(mapping=aes(x=log(binom_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Binomial Option Tree",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#MSE
library('MLmetrics')
MSE(y_mean_values_SGP,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(y_mean_values_bs,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(blackscholes_test,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(predict_testNN,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(yhat.bag,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(yhat.rf,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(binom_test,stan_dat$total_puts_American$mid_price[test_start:test_end])

#Computational Time
library('base')
#SGP
system.time(stan(file="gp-fit-6dimension_SGP.stan", data=stan_dat,
               iter=100, chains=1))
system.time(stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_SGP_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param'))

#BSGP
system.time(stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1))
system.time(stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param'))

#BS
system.time(for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
})

#Neural Net
system.time(neuralnet(y_scaled ~ x_1 + x_2 + x_3 + x_4 + x_5 + x_6, data=train, hidden=c(5,3),linear.output=TRUE ,threshold=0.01))
system.time(neuralnet::compute(nn, test[,c(1:6)]))

#Bagging
system.time(randomForest(y_scaled~., data = train, mtry = 6, importance = TRUE))
system.time(predict(bagging, newdata = test))

#Random Forest
system.time(randomForest(y_scaled~., data = train, mtry = 2, importance = TRUE))
system.time(predict(rf, newdata = test))

#Binomial Option Tree
system.time(for (row in 1:nrow(data.frame(x2_bs))){
  binom_test[row] <- binomopt(s=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],k=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],v=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],tt=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],d=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row], nstep = 6000, american=TRUE, putopt=TRUE)
})
```

## Part 9: Delta Hedging Back-test

9-1 Computing Actual Delta for the next day

```{r}
#6/3 ~ 6/7 training + 6/10 test and hedge for 6/11
tmr_start_backtest_1 <- 394 #6/11
tmr_end_backtest_1 <- 465 #6/11

test_start_backtest_1 <- 323 #Start of 06/10 Puts
test_end_backtest_1 <- 393 # End of 06/10 Puts


tmr_options_1 <- stan_dat$total_puts_American[tmr_start_backtest_1:tmr_end_backtest_1,]
today_options_1 <- stan_dat$total_puts_American[test_start_backtest_1:test_end_backtest_1,]

#6/3 ~ 6/7, 6/10 training + 6/11 test and hedge for 6/12
tmr_start_backtest_2 <- 466 #6/12
tmr_end_backtest_2 <- 486 #6/12

test_start_backtest_2 <- 394 #Start of 06/11 Puts
test_end_backtest_2 <- 465 # End of 06/11 Puts


tmr_options_2 <- stan_dat$total_puts_American[tmr_start_backtest_2:tmr_end_backtest_2,]
today_options_2 <- stan_dat$total_puts_American[test_start_backtest_2:test_end_backtest_2,]

#6/3 ~ 6/7, 6/10~6/11 training + 6/12 test and hedge for 6/13
tmr_start_backtest_3 <- 487 #6/13
tmr_end_backtest_3 <- 522 #6/13

test_start_backtest_3 <- 466 #Start of 06/12 Puts
test_end_backtest_3 <- 486 # End of 06/12 Puts


tmr_options_3 <- stan_dat$total_puts_American[tmr_start_backtest_3:tmr_end_backtest_3,]
today_options_3 <- stan_dat$total_puts_American[test_start_backtest_3:test_end_backtest_3,]

#6/3 ~ 6/7, 6/10~6/12 training + 6/13 test and hedge for 6/14
tmr_start_backtest_4 <- 523 #6/14
tmr_end_backtest_4 <- 559 #6/14

test_start_backtest_4 <- 487 #Start of 06/13 Puts
test_end_backtest_4 <- 522 # End of 06/13 Puts


tmr_options_4 <- stan_dat$total_puts_American[tmr_start_backtest_4:tmr_end_backtest_4,]
today_options_4 <- stan_dat$total_puts_American[test_start_backtest_4:test_end_backtest_4,]

#6/3 ~ 6/7, 6/10~6/13 training + 6/14 test and hedge for 6/15
tmr_start_backtest_5 <- 560 #6/15
tmr_end_backtest_5 <- 580 #6/15

test_start_backtest_5 <- 523 #Start of 06/14 Puts
test_end_backtest_5 <- 559 # End of 06/14 Puts


tmr_options_5 <- stan_dat$total_puts_American[tmr_start_backtest_5:tmr_end_backtest_5,]
today_options_5 <- stan_dat$total_puts_American[test_start_backtest_5:test_end_backtest_5,]

```

```{r}
#filtering out options that are present both today and tmr
tmr_data_1 <- stan_dat$total_puts_American$optionid[tmr_start_backtest_1:tmr_end_backtest_1]
today_data_1 <- stan_dat$total_puts_American$optionid[test_start_backtest_1:test_end_backtest_1]

IDs_1<- unique(today_data_1[today_data_1%in%tmr_data_1])

tmr_option_price_1 <- tmr_options_1 %>% 
  filter(optionid %in% IDs_1 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
today_option_price_1 <- today_options_1 %>% 
  filter(optionid %in% IDs_1 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
tmr_underlying_price_1 <- tmr_options_1 %>% 
  filter(optionid %in% IDs_1 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)
today_underlying_price_1 <- today_options_1 %>% 
  filter(optionid %in% IDs_1 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)

#filtering out options that are present both today and tmr
tmr_data_2 <- stan_dat$total_puts_American$optionid[tmr_start_backtest_2:tmr_end_backtest_2]
today_data_2 <- stan_dat$total_puts_American$optionid[test_start_backtest_2:test_end_backtest_2]

IDs_2<- unique(today_data_2[today_data_2%in%tmr_data_2])

tmr_option_price_2 <- tmr_options_2 %>% 
  filter(optionid %in% IDs_2 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
today_option_price_2 <- today_options_2 %>% 
  filter(optionid %in% IDs_2 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
tmr_underlying_price_2 <- tmr_options_2 %>% 
  filter(optionid %in% IDs_2 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)
today_underlying_price_2 <- today_options_2 %>% 
  filter(optionid %in% IDs_2 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)

#filtering out options that are present both today and tmr
tmr_data_3 <- stan_dat$total_puts_American$optionid[tmr_start_backtest_3:tmr_end_backtest_3]
today_data_3 <- stan_dat$total_puts_American$optionid[test_start_backtest_3:test_end_backtest_3]

IDs_3<- unique(today_data_3[today_data_3%in%tmr_data_3])

tmr_option_price_3 <- tmr_options_3 %>% 
  filter(optionid %in% IDs_3 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
today_option_price_3 <- today_options_3 %>% 
  filter(optionid %in% IDs_3 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
tmr_underlying_price_3 <- tmr_options_3 %>% 
  filter(optionid %in% IDs_3 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)
today_underlying_price_3 <- today_options_3 %>% 
  filter(optionid %in% IDs_3 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)

#filtering out options that are present both today and tmr
tmr_data_4 <- stan_dat$total_puts_American$optionid[tmr_start_backtest_4:tmr_end_backtest_4]
today_data_4 <- stan_dat$total_puts_American$optionid[test_start_backtest_4:test_end_backtest_4]

IDs_4<- unique(today_data_4[today_data_4%in%tmr_data_4])

tmr_option_price_4 <- tmr_options_4 %>% 
  filter(optionid %in% IDs_4 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
today_option_price_4 <- today_options_4 %>% 
  filter(optionid %in% IDs_4 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
tmr_underlying_price_4 <- tmr_options_4 %>% 
  filter(optionid %in% IDs_4 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)
today_underlying_price_4 <- today_options_4 %>% 
  filter(optionid %in% IDs_4 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)

#filtering out options that are present both today and tmr
tmr_data_5 <- stan_dat$total_puts_American$optionid[tmr_start_backtest_5:tmr_end_backtest_5]
today_data_5 <- stan_dat$total_puts_American$optionid[test_start_backtest_5:test_end_backtest_5]

IDs_5<- unique(today_data_5[today_data_5%in%tmr_data_5])

tmr_option_price_5 <- tmr_options_5 %>% 
  filter(optionid %in% IDs_5 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
today_option_price_5 <- today_options_5 %>% 
  filter(optionid %in% IDs_5 == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
tmr_underlying_price_5 <- tmr_options_5 %>% 
  filter(optionid %in% IDs_5 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)
today_underlying_price_5 <- today_options_5 %>% 
  filter(optionid %in% IDs_5 == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)

```

9-2 Generating BSGP prices for Backtesting

```{r Backtest-Setting test to today}

x_1_backtest_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_2_backtest_1 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest_1:test_end_backtest_1])
x_3_backtest_1 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest_1:test_end_backtest_1])
x_4_backtest_1 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest_1:test_end_backtest_1])
x_5_backtest_1 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest_1:test_end_backtest_1])
x_6_backtest_1 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest_1:test_end_backtest_1])
x2_backtest_1 <- cbind(x_1_backtest_1,x_2_backtest_1,x_3_backtest_1,x_4_backtest_1,x_5_backtest_1,x_6_backtest_1)[c(match(IDs_1,today_data_1)),]

x_1_backtest_2 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest_2:test_end_backtest_2])
x_2_backtest_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest_2:test_end_backtest_2])
x_3_backtest_2 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest_2:test_end_backtest_2])
x_4_backtest_2 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest_2:test_end_backtest_2])
x_5_backtest_2 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest_2:test_end_backtest_2])
x_6_backtest_2 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest_2:test_end_backtest_2])
x2_backtest_2 <- cbind(x_1_backtest_2,x_2_backtest_2,x_3_backtest_2,x_4_backtest_2,x_5_backtest_2,x_6_backtest_2)[c(match(IDs_2,today_data_2)),]

x_1_backtest_3 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest_3:test_end_backtest_3])
x_2_backtest_3 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest_3:test_end_backtest_3])
x_3_backtest_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest_3:test_end_backtest_3])
x_4_backtest_3 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest_3:test_end_backtest_3])
x_5_backtest_3 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest_3:test_end_backtest_3])
x_6_backtest_3 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest_3:test_end_backtest_3])
x2_backtest_3 <- cbind(x_1_backtest_3,x_2_backtest_3,x_3_backtest_3,x_4_backtest_3,x_5_backtest_3,x_6_backtest_3)[c(match(IDs_3,today_data_3)),]

x_1_backtest_4 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest_4:test_end_backtest_4])
x_2_backtest_4 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest_4:test_end_backtest_4])
x_3_backtest_4 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest_4:test_end_backtest_4])
x_4_backtest_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest_4:test_end_backtest_4])
x_5_backtest_4 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest_4:test_end_backtest_4])
x_6_backtest_4 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest_4:test_end_backtest_4])
x2_backtest_4 <- cbind(x_1_backtest_4,x_2_backtest_4,x_3_backtest_4,x_4_backtest_4,x_5_backtest_4,x_6_backtest_4)[c(match(IDs_4,today_data_4)),]

x_1_backtest_5 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest_5:test_end_backtest_5])
x_2_backtest_5 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest_5:test_end_backtest_5])
x_3_backtest_5 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest_5:test_end_backtest_5])
x_4_backtest_5 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest_5:test_end_backtest_5])
x_5_backtest_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest_5:test_end_backtest_5])
x_6_backtest_5 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest_5:test_end_backtest_5])
x2_backtest_5 <- cbind(x_1_backtest_5,x_2_backtest_5,x_3_backtest_5,x_4_backtest_5,x_5_backtest_5,x_6_backtest_5)[c(match(IDs_5,today_data_5)),]
```

```{r computing blackscholes for backtest}

library('qrmtools')
library('ragtop')

x2_bs_backtest_1 <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest_1:test_end_backtest_1]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest_1:test_end_backtest_1]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest_1:test_end_backtest_1]))[c(match(IDs_1,today_data_1)),]

blackscholes_test_backtest_1 <- rep(NA,length(x2_bs_backtest_1[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_1))){
  blackscholes_test_backtest_1[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest_1[row,1]),K=as.numeric(x2_bs_backtest_1[row,2]),r=as.numeric(x2_bs_backtest_1[row,6]),t=as.numeric(x2_bs_backtest_1[row,4]),vola=as.numeric(x2_bs_backtest_1[row,3]),divrate=as.numeric(x2_bs_backtest_1[row,5]))$Price)
}

x2_bs_backtest_2 <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest_2:test_end_backtest_2]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest_2:test_end_backtest_2]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest_2:test_end_backtest_2]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest_2:test_end_backtest_2]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest_2:test_end_backtest_2]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest_2:test_end_backtest_2]))[c(match(IDs_2,today_data_2)),]

blackscholes_test_backtest_2 <- rep(NA,length(x2_bs_backtest_2[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_2))){
  blackscholes_test_backtest_2[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest_2[row,1]),K=as.numeric(x2_bs_backtest_2[row,2]),r=as.numeric(x2_bs_backtest_2[row,6]),t=as.numeric(x2_bs_backtest_2[row,4]),vola=as.numeric(x2_bs_backtest_2[row,3]),divrate=as.numeric(x2_bs_backtest_2[row,5]))$Price)
}

x2_bs_backtest_3 <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest_3:test_end_backtest_3]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest_3:test_end_backtest_3]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest_3:test_end_backtest_3]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest_3:test_end_backtest_3]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest_3:test_end_backtest_3]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest_3:test_end_backtest_3]))[c(match(IDs_3,today_data_3)),]

blackscholes_test_backtest_3 <- rep(NA,length(x2_bs_backtest_3[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_3))){
  blackscholes_test_backtest_3[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest_3[row,1]),K=as.numeric(x2_bs_backtest_3[row,2]),r=as.numeric(x2_bs_backtest_3[row,6]),t=as.numeric(x2_bs_backtest_3[row,4]),vola=as.numeric(x2_bs_backtest_3[row,3]),divrate=as.numeric(x2_bs_backtest_3[row,5]))$Price)
}

x2_bs_backtest_4 <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest_4:test_end_backtest_4]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest_4:test_end_backtest_4]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest_4:test_end_backtest_4]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest_4:test_end_backtest_4]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest_4:test_end_backtest_4]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest_4:test_end_backtest_4]))[c(match(IDs_4,today_data_4)),]

blackscholes_test_backtest_4 <- rep(NA,length(x2_bs_backtest_4[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_4))){
  blackscholes_test_backtest_4[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest_4[row,1]),K=as.numeric(x2_bs_backtest_4[row,2]),r=as.numeric(x2_bs_backtest_4[row,6]),t=as.numeric(x2_bs_backtest_4[row,4]),vola=as.numeric(x2_bs_backtest_4[row,3]),divrate=as.numeric(x2_bs_backtest_4[row,5]))$Price)
}

x2_bs_backtest_5 <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest_5:test_end_backtest_5]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest_5:test_end_backtest_5]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest_5:test_end_backtest_5]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest_5:test_end_backtest_5]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest_5:test_end_backtest_5]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest_5:test_end_backtest_5]))[c(match(IDs_5,today_data_5)),]

blackscholes_test_backtest_5 <- rep(NA,length(x2_bs_backtest_5[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest_5))){
  blackscholes_test_backtest_5[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest_5[row,1]),K=as.numeric(x2_bs_backtest_5[row,2]),r=as.numeric(x2_bs_backtest_5[row,6]),t=as.numeric(x2_bs_backtest_5[row,4]),vola=as.numeric(x2_bs_backtest_5[row,3]),divrate=as.numeric(x2_bs_backtest_5[row,5]))$Price)
}

```

```{r Predictions_Backtest to predict for today}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)

post_data_bs_American_backtest_1 <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_backtest_1,N1=length(stan_dat$x[,1]),N2=length(x2_backtest_1[,1]), bs = blackscholes_test_backtest_1,variables = 6)
# post_data

pred_gp_bs_backtest_1 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
# ---------------------------------------------------
# Fitting GP model
stan_dat_2 <- read_rdump('Financial_Data_Put_American_2.R')
fit_gp_bs_American_2 <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat_2,
               iter=100, chains=1);
print(fit_gp_bs_American_2, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American_2 <- extract(fit_gp_bs_American_2,permuted=FALSE)

# Predicting from GP model - 2 dimensional case
post_mean_theta_1_bs_2 <- mean(sum_gp_bs_American_2[,1,1]) #theta
post_mean_theta_2_bs_2 <- mean(sum_gp_bs_American_2[,1,2]) #theta
post_mean_theta_3_bs_2 <- mean(sum_gp_bs_American_2[,1,3]) #theta
post_mean_theta_4_bs_2 <- mean(sum_gp_bs_American_2[,1,4]) #theta
post_mean_theta_5_bs_2 <- mean(sum_gp_bs_American_2[,1,5]) #theta
post_mean_theta_6_bs_2 <- mean(sum_gp_bs_American_2[,1,6]) #theta
post_mean_sigma2_bs_2 <- mean(sum_gp_bs_American_2[,1,7]) #sigma2
post_mean_gamma2_bs_2 <- mean(sum_gp_bs_American_2[,1,8]) #gamma2
post_mean_mu_bs_2 <- stan_dat_2$blackscholes


post_data_bs_American_backtest_2 <- list(theta=c(post_mean_theta_1_bs_2,post_mean_theta_2_bs_2,post_mean_theta_3_bs_2,post_mean_theta_4_bs_2,post_mean_theta_5_bs_2,post_mean_theta_6_bs_2),sigma2=post_mean_sigma2_bs_2,gamma2=post_mean_gamma2_bs_2,mu=post_mean_mu_bs_2,x_train=stan_dat_2$x,y1=stan_dat_2$y,x_test=x2_backtest_2,N1=length(stan_dat_2$x[,1]),N2=length(x2_backtest_2[,1]), bs = blackscholes_test_backtest_2,variables = 6)
# post_data

pred_gp_bs_backtest_2 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_2,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

# ------------------------------------
# Fitting GP model
stan_dat_3 <- read_rdump('Financial_Data_Put_American_3.R')
fit_gp_bs_American_3 <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat_3,
               iter=100, chains=1);
print(fit_gp_bs_American_3, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American_3 <- extract(fit_gp_bs_American_2,permuted=FALSE)

# Predicting from GP model - 2 dimensional case
post_mean_theta_1_bs_3 <- mean(sum_gp_bs_American_3[,1,1]) #theta
post_mean_theta_2_bs_3 <- mean(sum_gp_bs_American_3[,1,2]) #theta
post_mean_theta_3_bs_3 <- mean(sum_gp_bs_American_3[,1,3]) #theta
post_mean_theta_4_bs_3 <- mean(sum_gp_bs_American_3[,1,4]) #theta
post_mean_theta_5_bs_3 <- mean(sum_gp_bs_American_3[,1,5]) #theta
post_mean_theta_6_bs_3 <- mean(sum_gp_bs_American_3[,1,6]) #theta
post_mean_sigma2_bs_3 <- mean(sum_gp_bs_American_3[,1,7]) #sigma2
post_mean_gamma2_bs_3 <- mean(sum_gp_bs_American_3[,1,8]) #gamma2
post_mean_mu_bs_3 <- stan_dat_3$blackscholes


post_data_bs_American_backtest_3 <- list(theta=c(post_mean_theta_1_bs_3,post_mean_theta_2_bs_3,post_mean_theta_3_bs_3,post_mean_theta_4_bs_3,post_mean_theta_5_bs_3,post_mean_theta_6_bs_3),sigma2=post_mean_sigma2_bs_3,gamma2=post_mean_gamma2_bs_3,mu=post_mean_mu_bs_3,x_train=stan_dat_3$x,y1=stan_dat_3$y,x_test=x2_backtest_3,N1=length(stan_dat_3$x[,1]),N2=length(x2_backtest_3[,1]), bs = blackscholes_test_backtest_3,variables = 6)
# post_data

pred_gp_bs_backtest_3 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_3,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

# ------------------------------------
# Fitting GP model
stan_dat_4 <- read_rdump('Financial_Data_Put_American_4.R')
fit_gp_bs_American_4 <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat_4,
               iter=100, chains=1);
print(fit_gp_bs_American_4, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American_4 <- extract(fit_gp_bs_American_4,permuted=FALSE)

# Predicting from GP model - 2 dimensional case
post_mean_theta_1_bs_4 <- mean(sum_gp_bs_American_4[,1,1]) #theta
post_mean_theta_2_bs_4 <- mean(sum_gp_bs_American_4[,1,2]) #theta
post_mean_theta_3_bs_4 <- mean(sum_gp_bs_American_4[,1,3]) #theta
post_mean_theta_4_bs_4 <- mean(sum_gp_bs_American_4[,1,4]) #theta
post_mean_theta_5_bs_4 <- mean(sum_gp_bs_American_4[,1,5]) #theta
post_mean_theta_6_bs_4 <- mean(sum_gp_bs_American_4[,1,6]) #theta
post_mean_sigma2_bs_4 <- mean(sum_gp_bs_American_4[,1,7]) #sigma2
post_mean_gamma2_bs_4 <- mean(sum_gp_bs_American_4[,1,8]) #gamma2
post_mean_mu_bs_4 <- stan_dat_4$blackscholes


post_data_bs_American_backtest_4 <- list(theta=c(post_mean_theta_1_bs_4,post_mean_theta_2_bs_4,post_mean_theta_3_bs_4,post_mean_theta_4_bs_4,post_mean_theta_5_bs_4,post_mean_theta_6_bs_4),sigma2=post_mean_sigma2_bs_4,gamma2=post_mean_gamma2_bs_4,mu=post_mean_mu_bs_4,x_train=stan_dat_4$x,y1=stan_dat_4$y,x_test=x2_backtest_4,N1=length(stan_dat_4$x[,1]),N2=length(x2_backtest_4[,1]), bs = blackscholes_test_backtest_4,variables = 6)
# post_data

pred_gp_bs_backtest_4 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_4,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

# ------------------------------------
# Fitting GP model
stan_dat_5 <- read_rdump('Financial_Data_Put_American_5.R')
fit_gp_bs_American_5 <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat_5,
               iter=100, chains=1);
print(fit_gp_bs_American_5, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American_5 <- extract(fit_gp_bs_American_5,permuted=FALSE)

# Predicting from GP model - 2 dimensional case
post_mean_theta_1_bs_5 <- mean(sum_gp_bs_American_5[,1,1]) #theta
post_mean_theta_2_bs_5 <- mean(sum_gp_bs_American_5[,1,2]) #theta
post_mean_theta_3_bs_5 <- mean(sum_gp_bs_American_5[,1,3]) #theta
post_mean_theta_4_bs_5 <- mean(sum_gp_bs_American_5[,1,4]) #theta
post_mean_theta_5_bs_5 <- mean(sum_gp_bs_American_5[,1,5]) #theta
post_mean_theta_6_bs_5 <- mean(sum_gp_bs_American_5[,1,6]) #theta
post_mean_sigma2_bs_5 <- mean(sum_gp_bs_American_5[,1,7]) #sigma2
post_mean_gamma2_bs_5 <- mean(sum_gp_bs_American_5[,1,8]) #gamma2
post_mean_mu_bs_5 <- stan_dat_5$blackscholes


post_data_bs_American_backtest_5 <- list(theta=c(post_mean_theta_1_bs_5,post_mean_theta_2_bs_5,post_mean_theta_3_bs_5,post_mean_theta_4_bs_5,post_mean_theta_5_bs_5,post_mean_theta_6_bs_5),sigma2=post_mean_sigma2_bs_5,gamma2=post_mean_gamma2_bs_5,mu=post_mean_mu_bs_5,x_train=stan_dat_5$x,y1=stan_dat_5$y,x_test=x2_backtest_5,N1=length(stan_dat_5$x[,1]),N2=length(x2_backtest_5[,1]), bs = blackscholes_test_backtest_5,variables = 6)
# post_data

pred_gp_bs_backtest_5 <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest_5,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

```{r Mean & SD of Predictions_bs}
#Computing Mean
y_predict_values_bs_backtest_1 <- extract(pred_gp_bs_backtest_1,permuted=FALSE)
y_mean_values_bs_backtest_1 <- c(colMeans(y_predict_values_bs_backtest_1))
y_mean_values_bs_backtest_1 <- y_mean_values_bs_backtest_1[1:(length(y_mean_values_bs_backtest_1)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_1 <- summary(pred_gp_bs_backtest_1, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_1 <- pred_gp_summary_bs_backtest_1[, c("sd")]
y_sd_values_bs_backtest_1 <- pred_gp_sd_bs_backtest_1[1:(length(pred_gp_sd_bs_backtest_1)-1)]

# ----------------------------------
#Computing Mean
y_predict_values_bs_backtest_2 <- extract(pred_gp_bs_backtest_2,permuted=FALSE)
y_mean_values_bs_backtest_2 <- c(colMeans(y_predict_values_bs_backtest_2))
y_mean_values_bs_backtest_2 <- y_mean_values_bs_backtest_2[1:(length(y_mean_values_bs_backtest_2)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_2 <- summary(pred_gp_bs_backtest_2, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_2 <- pred_gp_summary_bs_backtest_2[, c("sd")]
y_sd_values_bs_backtest_2 <- pred_gp_sd_bs_backtest_2[1:(length(pred_gp_sd_bs_backtest_2)-1)]

# ----------------------------------
#Computing Mean
y_predict_values_bs_backtest_3 <- extract(pred_gp_bs_backtest_3,permuted=FALSE)
y_mean_values_bs_backtest_3 <- c(colMeans(y_predict_values_bs_backtest_3))
y_mean_values_bs_backtest_3 <- y_mean_values_bs_backtest_3[1:(length(y_mean_values_bs_backtest_3)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_3 <- summary(pred_gp_bs_backtest_3, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_3 <- pred_gp_summary_bs_backtest_3[, c("sd")]
y_sd_values_bs_backtest_3 <- pred_gp_sd_bs_backtest_3[1:(length(pred_gp_sd_bs_backtest_3)-1)]

# ----------------------------------
#Computing Mean
y_predict_values_bs_backtest_4 <- extract(pred_gp_bs_backtest_4,permuted=FALSE)
y_mean_values_bs_backtest_4 <- c(colMeans(y_predict_values_bs_backtest_4))
y_mean_values_bs_backtest_4 <- y_mean_values_bs_backtest_4[1:(length(y_mean_values_bs_backtest_4)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_4 <- summary(pred_gp_bs_backtest_4, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_4 <- pred_gp_summary_bs_backtest_4[, c("sd")]
y_sd_values_bs_backtest_4 <- pred_gp_sd_bs_backtest_4[1:(length(pred_gp_sd_bs_backtest_4)-1)]

# ----------------------------------
#Computing Mean
y_predict_values_bs_backtest_5 <- extract(pred_gp_bs_backtest_5,permuted=FALSE)
y_mean_values_bs_backtest_5 <- c(colMeans(y_predict_values_bs_backtest_5))
y_mean_values_bs_backtest_5 <- y_mean_values_bs_backtest_5[1:(length(y_mean_values_bs_backtest_5)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest_5 <- summary(pred_gp_bs_backtest_5, sd=c("sd"))$summary
pred_gp_sd_bs_backtest_5 <- pred_gp_summary_bs_backtest_5[, c("sd")]
y_sd_values_bs_backtest_5 <- pred_gp_sd_bs_backtest_5[1:(length(pred_gp_sd_bs_backtest_5)-1)]
```

```{r predictive performance of backtest price for today}
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_1),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_1:test_end_backtest_1])[c(match(IDs_1,today_data_1))]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest_1,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_1:test_end_backtest_1])[c(match(IDs_1,today_data_1))])

# -----------------------------
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_2),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_2:test_end_backtest_2])[c(match(IDs_2,today_data_2))]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest_2,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_2:test_end_backtest_2])[c(match(IDs_2,today_data_2))])

# -----------------------------
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_3),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_3:test_end_backtest_3])[c(match(IDs_3,today_data_3))]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest_3,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_3:test_end_backtest_3])[c(match(IDs_3,today_data_3))])

# -----------------------------
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_4),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_4:test_end_backtest_4])[c(match(IDs_4,today_data_4))]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest_4,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_4:test_end_backtest_4])[c(match(IDs_4,today_data_4))])

# -----------------------------
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest_5),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_5:test_end_backtest_5])[c(match(IDs_5,today_data_5))]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest_5,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest_5:test_end_backtest_5])[c(match(IDs_5,today_data_5))])
```

9-3 Computing BS Delta

```{r compute BSGP delta}
library(derivmkts)
BS_Delta_1 <- greeks(bsput(s=as.numeric(x2_bs_backtest_1[,1]), k=as.numeric(x2_bs_backtest_1[,2]), v=as.numeric(x2_bs_backtest_1[,3]), r=as.numeric(x2_bs_backtest_1[,6]), tt=as.numeric(x2_bs_backtest_1[,4]), d=as.numeric(x2_bs_backtest_1[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_1

# -----------------------
BS_Delta_2 <- greeks(bsput(s=as.numeric(x2_bs_backtest_2[,1]), k=as.numeric(x2_bs_backtest_2[,2]), v=as.numeric(x2_bs_backtest_2[,3]), r=as.numeric(x2_bs_backtest_2[,6]), tt=as.numeric(x2_bs_backtest_2[,4]), d=as.numeric(x2_bs_backtest_2[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_2

# -----------------------\
BS_Delta_3 <- greeks(bsput(s=as.numeric(x2_bs_backtest_3[,1]), k=as.numeric(x2_bs_backtest_3[,2]), v=as.numeric(x2_bs_backtest_3[,3]), r=as.numeric(x2_bs_backtest_3[,6]), tt=as.numeric(x2_bs_backtest_3[,4]), d=as.numeric(x2_bs_backtest_3[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_3

# -----------------------
BS_Delta_4 <- greeks(bsput(s=as.numeric(x2_bs_backtest_4[,1]), k=as.numeric(x2_bs_backtest_4[,2]), v=as.numeric(x2_bs_backtest_4[,3]), r=as.numeric(x2_bs_backtest_4[,6]), tt=as.numeric(x2_bs_backtest_4[,4]), d=as.numeric(x2_bs_backtest_4[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_4

# -----------------------
BS_Delta_5 <- greeks(bsput(s=as.numeric(x2_bs_backtest_5[,1]), k=as.numeric(x2_bs_backtest_5[,2]), v=as.numeric(x2_bs_backtest_5[,3]), r=as.numeric(x2_bs_backtest_5[,6]), tt=as.numeric(x2_bs_backtest_5[,4]), d=as.numeric(x2_bs_backtest_5[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta_5

```

9-4 Computing BSGP vector C & vector K'

```{r}
vector_c_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')


vector_c_values_1 <- extract(vector_c_values_1,permuted=FALSE)
vector_c_values_1 <- c(colMeans(vector_c_values_1))
vector_c_values_1 <- vector_c_values_1[1:(length(vector_c_values_1)-1)]

vector_k_values_1 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_1,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



vector_k_values_1 <- extract(vector_k_values_1,permuted=FALSE)
vector_k_values_1 <- c(colMeans(vector_k_values_1))
vector_k_values_1 <- vector_k_values_1[1:(length(vector_k_values_1)-1)]


vector_k_1 <- matrix(vector_k_values_1, nrow(x2_backtest_1), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta_1 <- BS_Delta_1 + vector_k_1 %*% vector_c_values_1


# --------------------------------
vector_c_values_2 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_2,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')


vector_c_values_2 <- extract(vector_c_values_2,permuted=FALSE)
vector_c_values_2 <- c(colMeans(vector_c_values_2))
vector_c_values_2 <- vector_c_values_2[1:(length(vector_c_values_2)-1)]

vector_k_values_2 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_2,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



vector_k_values_2 <- extract(vector_k_values_2,permuted=FALSE)
vector_k_values_2 <- c(colMeans(vector_k_values_2))
vector_k_values_2 <- vector_k_values_2[1:(length(vector_k_values_2)-1)]


vector_k_2 <- matrix(vector_k_values_2, nrow(x2_backtest_2), nrow(stan_dat_2$x), byrow=FALSE)

BSGP_Delta_2 <- BS_Delta_2 + vector_k_2 %*% vector_c_values_2

# --------------------------------
vector_c_values_3 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_3,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')


vector_c_values_3 <- extract(vector_c_values_3,permuted=FALSE)
vector_c_values_3 <- c(colMeans(vector_c_values_3))
vector_c_values_3 <- vector_c_values_3[1:(length(vector_c_values_3)-1)]

vector_k_values_3 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_3,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



vector_k_values_3 <- extract(vector_k_values_3,permuted=FALSE)
vector_k_values_3 <- c(colMeans(vector_k_values_3))
vector_k_values_3 <- vector_k_values_3[1:(length(vector_k_values_3)-1)]


vector_k_3 <- matrix(vector_k_values_3, nrow(x2_backtest_3), nrow(stan_dat_3$x), byrow=FALSE)

BSGP_Delta_3 <- BS_Delta_3 + vector_k_3 %*% vector_c_values_3

# --------------------------------
vector_c_values_4 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_4,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')


vector_c_values_4 <- extract(vector_c_values_4,permuted=FALSE)
vector_c_values_4 <- c(colMeans(vector_c_values_4))
vector_c_values_4 <- vector_c_values_4[1:(length(vector_c_values_4)-1)]

vector_k_values_4 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_4,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



vector_k_values_4 <- extract(vector_k_values_4,permuted=FALSE)
vector_k_values_4 <- c(colMeans(vector_k_values_4))
vector_k_values_4 <- vector_k_values_4[1:(length(vector_k_values_4)-1)]


vector_k_4 <- matrix(vector_k_values_4, nrow(x2_backtest_4), nrow(stan_dat_4$x), byrow=FALSE)

BSGP_Delta_4 <- BS_Delta_4 + vector_k_4 %*% vector_c_values_4

# --------------------------------
vector_c_values_5 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest_5,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')


vector_c_values_5 <- extract(vector_c_values_5,permuted=FALSE)
vector_c_values_5 <- c(colMeans(vector_c_values_5))
vector_c_values_5 <- vector_c_values_5[1:(length(vector_c_values_5)-1)]

vector_k_values_5 <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest_5,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



vector_k_values_5 <- extract(vector_k_values_5,permuted=FALSE)
vector_k_values_5 <- c(colMeans(vector_k_values_5))
vector_k_values_5 <- vector_k_values_5[1:(length(vector_k_values_5)-1)]


vector_k_5 <- matrix(vector_k_values_5, nrow(x2_backtest_5), nrow(stan_dat_5$x), byrow=FALSE)

BSGP_Delta_5 <- BS_Delta_5 + vector_k_5 %*% vector_c_values_5
```

9-5 Choosing which options to use

```{r}
hist(BS_Delta_1-BSGP_Delta_1)
plot(BS_Delta_1,BSGP_Delta_1)
abline(intercept = 0, slope = 1)
selected_options <- sort(BS_Delta_1-BSGP_Delta_1, index.return=TRUE, decreasing=TRUE)$ix[1]
BSGP_Delta_1[c(selected_options)]
BS_Delta_1[c(selected_options)]

# BSGP_Delta_portfolio <- sum(BSGP_Delta[c(selected_options)])
# BS_Delta_portfolio <- sum(BS_Delta[c(selected_options)])
# 
# BSGP_Delta_portfolio_1 <- sum(BSGP_Delta_1)
# BS_Delta_portfolio_1 <- sum(BS_Delta_1)

##Assuming we hedge with the SPY closing price
##6/10 closing price for SPY: 288.97
##6/11 closing price for SPY: 288.9

BSGP_hedge_cost_1 <- 288.97*abs(BSGP_Delta_portfolio_1)*100
BS_hedge_cost_1 <- 288.97*abs(BS_Delta_portfolio_1)*100

BSGP_portfolio_value_change_1 <- (sum(tmr_option_price_1$mid_price)-sum(today_option_price_1$mid_price)) + ((288.9-288.97)*abs(BSGP_Delta_portfolio_1)*100)

BS_portfolio_value_change_1 <- (sum(tmr_option_price_1$mid_price)-sum(today_option_price_1$mid_price)) + ((288.9-288.97)*abs(BS_Delta_portfolio_1)*100)

BSGP_portfolio_value_change_1
BS_portfolio_value_change_1

# --------------------------------------
BSGP_Delta_portfolio_2 <- sum(BSGP_Delta_2)
BS_Delta_portfolio_2 <- sum(BS_Delta_2)

BSGP_hedge_cost_2 <- 288.9*abs(BSGP_Delta_portfolio_2)*100
BS_hedge_cost_2 <- 288.9*abs(BS_Delta_portfolio_2)*100

BSGP_portfolio_value_change_2 <- (sum(tmr_option_price_2$mid_price)-sum(today_option_price_2$mid_price)) + ((288.39-288.9)*abs(BSGP_Delta_portfolio_2)*100)

BS_portfolio_value_change_2 <- (sum(tmr_option_price_2$mid_price)-sum(today_option_price_2$mid_price)) + ((288.39-288.9)*abs(BS_Delta_portfolio_2)*100)

BSGP_portfolio_value_change_2
BS_portfolio_value_change_2
# --------------------------------------
BSGP_Delta_portfolio_3 <- sum(BSGP_Delta_3)
BS_Delta_portfolio_3 <- sum(BS_Delta_3)

BSGP_hedge_cost_3 <- 288.39*abs(BSGP_Delta_portfolio_3)*100
BS_hedge_cost_3 <- 288.39*abs(BS_Delta_portfolio_3)*100

BSGP_portfolio_value_change_3 <- (sum(tmr_option_price_3$mid_price)-sum(today_option_price_3$mid_price)) + ((289.58-288.39)*abs(BSGP_Delta_portfolio_3)*100)

BS_portfolio_value_change_3 <- (sum(tmr_option_price_3$mid_price)-sum(today_option_price_3$mid_price)) + ((289.58-288.39)*abs(BS_Delta_portfolio_3)*100)

BSGP_portfolio_value_change_3
BS_portfolio_value_change_3

# --------------------------------------
BSGP_Delta_portfolio_4 <- sum(BSGP_Delta_4)
BS_Delta_portfolio_4 <- sum(BS_Delta_4)

BSGP_hedge_cost_4 <- 289.58*abs(BSGP_Delta_portfolio_4)*100
BS_hedge_cost_4 <- 289.58*abs(BS_Delta_portfolio_4)*100

BSGP_portfolio_value_change_4 <- (sum(tmr_option_price_4$mid_price)-sum(today_option_price_4$mid_price)) + ((289.26-289.58)*abs(BSGP_Delta_portfolio_4)*100)

BS_portfolio_value_change_4 <- (sum(tmr_option_price_4$mid_price)-sum(today_option_price_4$mid_price)) + ((289.26-289.58)*abs(BS_Delta_portfolio_4)*100)

BSGP_portfolio_value_change_4
BS_portfolio_value_change_4

# --------------------------------------
BSGP_Delta_portfolio_5 <- sum(BSGP_Delta_5)
BS_Delta_portfolio_5 <- sum(BS_Delta_5)



BSGP_hedge_cost_5 <- 289.26*abs(BSGP_Delta_portfolio_5)*100
BS_hedge_cost_5 <- 289.26*abs(BS_Delta_portfolio_5)*100

BSGP_portfolio_value_change_5 <- (sum(tmr_option_price_5$mid_price)-sum(today_option_price_5$mid_price)) + ((289.37-289.26)*abs(BSGP_Delta_portfolio_5)*100)

BS_portfolio_value_change_5 <- (sum(tmr_option_price_5$mid_price)-sum(today_option_price_5$mid_price)) + ((289.37-289.26)*abs(BS_Delta_portfolio_5)*100)

BSGP_portfolio_value_change_5
BS_portfolio_value_change_5

#-------
BSGP_portfolio_value_change <- BSGP_portfolio_value_change_1 + BSGP_portfolio_value_change_2 + BSGP_portfolio_value_change_3 + BSGP_portfolio_value_change_4 + BSGP_portfolio_value_change_5
BS_portfolio_value_change <- BS_portfolio_value_change_1 + BS_portfolio_value_change_2 + BS_portfolio_value_change_3 + BS_portfolio_value_change_4 + BS_portfolio_value_change_5

BSGP_portfolio_value_change
BS_portfolio_value_change

#one week of training June 3~7th
#1) predict BSGP June 10th to hedge June 11th
#2) use BSGP June 3~7th, 10th to train then predict June 11th BSGP to hedge June 12th

```


9-6 Comparing Performance

```{r}
mean(abs(BSGP_Delta - Real_delta))
mean(abs(BS_Delta - Real_delta))

Delta_data <- cbind(BSGP_Delta,BS_Delta)

ggplot(mapping=aes(x=BSGP_Delta,y=Real_delta)) +
  geom_point() +
  labs(title = "BSGP Delta vs Actual Delta",
       x = "BSGP Delta",
       y = "Observed Delta") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


ggplot(mapping=aes(x=BS_Delta,y=Real_delta)) +
  geom_point() +
  labs(title = "BS Delta vs Actual Delta",
       x = "BS Delta",
       y = "Observed Delta") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

matplot(Delta_data,Real_delta,type="o", xlab = "BSGP Delta & BS Delta", ylab = "Observed Delta")

```

10.Learning the Influence Coefficient

10-1 Distribution of Influence Coefficient

```{r}
IC <- abs(vector_c_values)
ggplot(mapping = aes(x=IC)) + geom_histogram()+
  labs(title = "Distribution of Influence Coefficient",
       x = "Values of Influence Coefficient",
       y = "Frequency") +
  theme_bw() +
  theme(text=element_text(size=16))

High_DAD <- c()
for (number in IC){
  if (number > unname(quantile(IC)[4])){
    High_DAD <- append(High_DAD,number)
  }
}

Low_DAD <- c()
for (number in IC){
  if (number < unname(quantile(IC)[2])){
    Low_DAD <- append(Low_DAD,number)
  }
}

High_DAD_data <- stan_dat$x[match(High_DAD,IC),]
Low_DAD_data <- stan_dat$x[match(Low_DAD,IC),]
DAD_data <- rbind(High_DAD_data,Low_DAD_data) 
DAD_values <- c(rep(1,times=length(High_DAD)), rep(0,times=length(Low_DAD)))

Training_option_price <- append(stan_dat$y[match(High_DAD,IC)], stan_dat$y[match(Low_DAD,IC)])
```

Try out decision tree/classification tree after dividing the DADs into two groups "High DAD" & "Low DAD" by median, maybe even random forest or more -> trying to visualize where the data is influential

10-2 Color Coded Map of Influence Coefficient

```{r}
# library(grid)
# grid.newpage()
#Spot vs Strike
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,2], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Strike",
       x = "Spot Price",
       y = "Strike Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Implied Volatility
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,3], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Implied Volatility",
       x = "Spot Price",
       y = "Implied Volatility") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Time to Expiration
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,4], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Time to Expiration",
       x = "Spot Price",
       y = "Time to Expiration") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Dividend Yield
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,5], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Dividend Yield",
       x = "Spot Price",
       y = "Dividend Yield") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Interest Rate
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,6], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Interest Rate",
       x = "Spot Price",
       y = "Interest Rate") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Option Price
ggplot(mapping=aes(x=DAD_data[,1],y=Training_option_price, color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Option Price",
       x = "Spot Price",
       y = "Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

```

##Prove the point of delta hedging(why use delta hedging with graphs)

##EDITS on JBES - cutting down on section 4

##4.5 - 3d plot of discrepancy and 2 variables (Ref photo) see if confidence interval includes 0. 2 plots -> 1st is just the discrepancy in 3d, 2nd is width of confidence interval in 3d + color code the plots as well.

#Code in SPY to automate the hedge test

#Make potential adjustments to the strategy-think about which options would've made a profit using the BSGP and figure out a way to choose them
#try different training week
#Scatterplot coded with where biggest absolute discrepancy
#Scatterplot color coded with uncertainty based on predictions
#Maybe try out the carry on for a week