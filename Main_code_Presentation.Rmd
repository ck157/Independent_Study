---
title: "Gaussian_Process_Code"
author: "Chiwan Kim"
date: "2/3/2020"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# In order to change to calls -> change the testing and training index numbers, change blackscholes formula (-1,1), change total_puts to total_calls
```

##Part 1: Standard Gaussian Process

1-1: Fitting

```{r Fitting_SGP, warning = FALSE}
library(rstan)
source("gp.utility.R")

# Fitting GP model
stan_dat <- read_rdump('Financial_Data_Put_American.R')
fit_gp_SGP_American <- stan(file="gp-fit-6dimension_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_SGP_American, pars = c('theta','sigma2','gamma2'))
sum_gp_SGP_American <- extract(fit_gp_SGP_American,permuted=FALSE)
```

```{r Computing Means for prediction_SGP}
# Predicting from GP model
post_mean_theta_1_SGP <- mean(sum_gp_SGP_American[,1,1]) #theta
post_mean_theta_2_SGP <- mean(sum_gp_SGP_American[,1,2]) #theta
post_mean_theta_3_SGP <- mean(sum_gp_SGP_American[,1,3]) #theta
post_mean_theta_4_SGP <- mean(sum_gp_SGP_American[,1,4]) #theta
post_mean_theta_5_SGP <- mean(sum_gp_SGP_American[,1,5]) #theta
post_mean_theta_6_SGP <- mean(sum_gp_SGP_American[,1,6]) #theta
post_mean_sigma2_SGP <- mean(sum_gp_SGP_American[,1,7]) #sigma2
post_mean_gamma2_SGP <- mean(sum_gp_SGP_American[,1,8]) #gamma2
post_mean_mu_SGP <- mean(sum_gp_SGP_American[,1,9])


```

```{r Blackscholes and assigning test data-1}
test_start <- 323 #06/10 Puts
test_end <- 559 #06/14 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
x2 <- cbind(x_1,x_2,x_3,x_4,x_5,x_6)
```


```{r computing blackscholes for test}
x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))


library('qrmtools')
library('ragtop')
blackscholes_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
}

```

1-2: Predictions

```{r Predictions_SGP}

post_data_SGP_American <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_SGP_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

##Part2:  BS Integrated SGP

2-1: Fitting

```{r Fitting_Bdrycov,warning = FALSE}
# Fitting GP model for Bdrycov
fit_gp_bs_American <- stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1);
print(fit_gp_bs_American, pars = c('theta','sigma2','gamma2'))
sum_gp_bs_American <- extract(fit_gp_bs_American,permuted=FALSE)
```

```{r Computing means for prediction_Bdrycov}
# Predicting from GP model - 2 dimensional case
post_mean_theta_1_bs <- mean(sum_gp_bs_American[,1,1]) #theta
post_mean_theta_2_bs <- mean(sum_gp_bs_American[,1,2]) #theta
post_mean_theta_3_bs <- mean(sum_gp_bs_American[,1,3]) #theta
post_mean_theta_4_bs <- mean(sum_gp_bs_American[,1,4]) #theta
post_mean_theta_5_bs <- mean(sum_gp_bs_American[,1,5]) #theta
post_mean_theta_6_bs <- mean(sum_gp_bs_American[,1,6]) #theta
post_mean_sigma2_bs <- mean(sum_gp_bs_American[,1,7]) #sigma2
post_mean_gamma2_bs <- mean(sum_gp_bs_American[,1,8]) #gamma2
post_mean_mu_bs <- stan_dat$blackscholes
```


2-2: Predictions

```{r Predictions_Bdrycov}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)

post_data_bs_American <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2,N1=length(stan_dat$x[,1]),N2=length(x2[,1]), bs = blackscholes_test,variables = 6)
# post_data

pred_gp_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

##Part 3 Predictions Versus Truth

3-1: Computing Means Standard GP

```{r Mean & SD of Predictions_SGP}
#Computing Mean
y_predict_values_SGP <- extract(pred_gp_SGP,permuted=FALSE)
y_mean_values_SGP <- c(colMeans(y_predict_values_SGP))
y_mean_values_SGP <- y_mean_values_SGP[1:(length(y_mean_values_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_SGP <- summary(pred_gp_SGP, sd=c("sd"))$summary
pred_gp_sd_SGP <- pred_gp_summary_SGP[, c("sd")]
y_sd_values_SGP <- pred_gp_sd_SGP[1:(length(pred_gp_sd_SGP)-1)]
```

3-2: Computing Means bs

```{r Mean & SD of Predictions_bs}
#Computing Mean
y_predict_values_bs <- extract(pred_gp_bs,permuted=FALSE)
y_mean_values_bs <- c(colMeans(y_predict_values_bs))
y_mean_values_bs <- y_mean_values_bs[1:(length(y_mean_values_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_bs <- summary(pred_gp_bs, sd=c("sd"))$summary
pred_gp_sd_bs <- pred_gp_summary_bs[, c("sd")]
y_sd_values_bs <- pred_gp_sd_bs[1:(length(pred_gp_sd_bs)-1)]
```

3-3: Plotting Predicted Values against Truth

```{r prediction accuracy}
par(mfrow=c(1,3))
#Plotting Standard GP
ggplot(mapping=aes(x=log(y_mean_values_SGP),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting bs
ggplot(mapping=aes(x=log(y_mean_values_bs),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


#Plotting Blackscholes
ggplot(mapping=aes(x=log(blackscholes_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

#MSE
library('MLmetrics')
MSE(y_mean_values_SGP,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(y_mean_values_bs,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(blackscholes_test,stan_dat$total_puts_American$mid_price[test_start:test_end])
```

##Part 4 MSE over Time

4-1: Plotting MSE over time


```{r}
#MSE
library('MLmetrics')
SGP_MSE_0610 <- MSE(y_mean_values_SGP[1:71],stan_dat$total_puts_American$mid_price[323:393])
SGP_MSE_0611 <- MSE(y_mean_values_SGP[72:143],stan_dat$total_puts_American$mid_price[394:465])
SGP_MSE_0612 <- MSE(y_mean_values_SGP[144:164],stan_dat$total_puts_American$mid_price[466:486])
SGP_MSE_0613 <- MSE(y_mean_values_SGP[165:200],stan_dat$total_puts_American$mid_price[487:522])
SGP_MSE_0614 <- MSE(y_mean_values_SGP[201:237],stan_dat$total_puts_American$mid_price[523:559])
SGP_MSE <- rbind(SGP_MSE_0610,SGP_MSE_0611,SGP_MSE_0612,SGP_MSE_0613,SGP_MSE_0614)

BS_SGP_MSE_0610 <- MSE(y_mean_values_bs[1:71],stan_dat$total_puts_American$mid_price[323:393])
BS_SGP_MSE_0611 <- MSE(y_mean_values_bs[72:143],stan_dat$total_puts_American$mid_price[394:465])
BS_SGP_MSE_0612 <- MSE(y_mean_values_bs[144:164],stan_dat$total_puts_American$mid_price[466:486])
BS_SGP_MSE_0613 <- MSE(y_mean_values_bs[165:200],stan_dat$total_puts_American$mid_price[487:522])
BS_SGP_MSE_0614 <- MSE(y_mean_values_bs[201:237],stan_dat$total_puts_American$mid_price[523:559])
BS_SGP_MSE <- rbind(BS_SGP_MSE_0610,BS_SGP_MSE_0611,BS_SGP_MSE_0612,BS_SGP_MSE_0613,BS_SGP_MSE_0614)

BS_MSE_0610 <- MSE(blackscholes_test[1:71],stan_dat$total_puts_American$mid_price[323:393])
BS_MSE_0611 <- MSE(blackscholes_test[72:143],stan_dat$total_puts_American$mid_price[394:465])
BS_MSE_0612 <- MSE(blackscholes_test[144:164],stan_dat$total_puts_American$mid_price[466:486])
BS_MSE_0613 <- MSE(blackscholes_test[165:200],stan_dat$total_puts_American$mid_price[487:522])
BS_MSE_0614 <- MSE(blackscholes_test[201:237],stan_dat$total_puts_American$mid_price[523:559])
BS_MSE <- rbind(BS_MSE_0610,BS_MSE_0611,BS_MSE_0612,BS_MSE_0613,BS_MSE_0614)

MSE_data <- as.data.frame(rbind(SGP_MSE,BS_SGP_MSE,BS_MSE))

MSE_data$date <- c(as.Date('00/00/0000', format = '%m/%d/%Y'))
MSE_data$date[c(1,6,11)] <- as.Date('06/10/2019', format = '%m/%d/%Y')
MSE_data$date[c(2,7,12)] <- as.Date('06/11/2019', format = '%m/%d/%Y')
MSE_data$date[c(3,8,13)] <- as.Date('06/12/2019', format = '%m/%d/%Y')
MSE_data$date[c(4,9,14)] <- as.Date('06/13/2019', format = '%m/%d/%Y')
MSE_data$date[c(5,10,15)] <- as.Date('06/14/2019', format = '%m/%d/%Y')

MSE_data$Method <- "Method"
MSE_data$Method[1:5] <- "SGP"
MSE_data$Method[6:10] <- "Black-Scholes Integrated_SGP"
MSE_data$Method[11:15] <- "Black-Scholes"

MSE_data <- MSE_data %>% 
  rename(MSE_values = V1)
  
#Plotting Blackscholes
ggplot(data=MSE_data, mapping=aes(x=date, y=MSE_values, colour = Method, shape = Method)) +
  geom_point(size = 2) +
  geom_line() +
  labs(title = "MSE Across Time",
       x = "Date",
       y = "Mean Squared Error") +
  theme_bw() +
  theme(text=element_text(size=16))
```


##Part 5 Interpretations

5-1: Contour Plots of Forward Price & Strike Price

```{r contour plots_forward_strike}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,1],K=x2_cont_bs[row,2],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,3],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Means in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Standard Deviation in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BS_GP Means in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BS_GP Standard Deviation in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), labcex = 2, main = "Black-Scholes Means in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Standard Deviation in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")

```

5-2: Contour Plots of Implied Volatility & Time to Expiration

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,4],r=x2_cont_bs[row,6],t=x2_cont_bs[row,2],vola=x2_cont_bs[row,1],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Standard Deviation in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Means in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Standard Deviation in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

5-3: Contour Plots of Strike Price and Implied Volatility

```{r contour plots_rates_time}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,1],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,2],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_SGP <- list(theta=c(post_mean_theta_1_SGP,post_mean_theta_2_SGP,post_mean_theta_3_SGP,post_mean_theta_4_SGP,post_mean_theta_5_SGP,post_mean_theta_6_SGP),sigma2=post_mean_sigma2_SGP,gamma2=post_mean_gamma2_SGP,mu=post_mean_mu_SGP,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_SGP <- stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_cont_SGP,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')

#Computing Mean
y_predict_values_cont_SGP <- extract(pred_gp_cont_SGP,permuted=FALSE)
y_mean_values_cont_SGP <- c(colMeans(y_predict_values_cont_SGP))
y_mean_values_cont_SGP <- y_mean_values_cont_SGP[1:(length(y_mean_values_cont_SGP)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_SGP <- summary(pred_gp_cont_SGP, sd=c("sd"))$summary
pred_gp_sd_cont_SGP <- pred_gp_summary_cont_SGP[, c("sd")]
y_sd_values_cont_SGP <- pred_gp_sd_cont_SGP[1:(length(pred_gp_sd_cont_SGP)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(y_mean_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Means in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(y_sd_values_cont_SGP, length(dim1), length(dim2)), labcex =1.5, main = "SGP Standard Deviation in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")

#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(y_mean_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Means in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(y_sd_values_cont_bs, length(dim1), length(dim2)), labcex =1.5, main = "BSGP Standard Deviation in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(blackscholes_test_cont, length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Means in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
#Contour of Variance
contour(dim1, dim2, matrix(sd(blackscholes_test_cont), length(dim1), length(dim2)), labcex =1.5, main = "Black-Scholes Standard Deviation in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

## Part 6: Standard Deviation of Predicted Values

6-1: Plotting Standard Deviation of Predictions

```{r}
par(mfrow=c(1,3))
ggplot(mapping = aes(x = seq(1:237),y=y_sd_values_SGP)) + geom_point(size = 2)+
  ylim(0,0.5)+ labs(title = "Standard Deviation of SGP",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

ggplot(mapping = aes(x = seq(1:237),y=y_sd_values_bs)) + geom_point(size = 2)+
  ylim(0,0.5)+
  labs(title = "Standard Deviation of Black-Scholes Integrated SGP",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

ggplot(mapping = aes(x = seq(1:237),y=rep(0,237))) + geom_point(size = 2)+
  ylim(0,0.5)+
  labs(title = "Standard Deviation of Black-Scholes",
       x = "Prediction Points",
       y = "Standard Deviation") +
  theme_bw() +
  theme(text=element_text(size=16))

mean(y_sd_values_SGP)
mean(y_sd_values_bs)
mean(0)
```

##Part 7 Discrepancy Modeling

7-1: Computing Discrepancy

```{r}
Discrepancy <- y_mean_values_bs - blackscholes_test

library('MLmetrics')
Discrepnacy_0610 <- mean(Discrepancy[1:71])
Discrepancy_0611 <- mean(Discrepancy[72:143])
Discrepancy_0612 <- mean(Discrepancy[144:164])
Discrepancy_0613 <- mean(Discrepancy[165:200])
Discrepancy_0614 <- mean(Discrepancy[201:237])
Discrepancy_data <- as.data.frame(rbind(SGP_MSE_0610,SGP_MSE_0611,SGP_MSE_0612,SGP_MSE_0613,SGP_MSE_0614))

Discrepancy_data$date <- c(as.Date('00/00/0000', format = '%m/%d/%Y'))
Discrepancy_data$date[1] <- as.Date('06/10/2019', format = '%m/%d/%Y')
Discrepancy_data$date[2] <- as.Date('06/11/2019', format = '%m/%d/%Y')
Discrepancy_data$date[3] <- as.Date('06/12/2019', format = '%m/%d/%Y')
Discrepancy_data$date[4] <- as.Date('06/13/2019', format = '%m/%d/%Y')
Discrepancy_data$date[5] <- as.Date('06/14/2019', format = '%m/%d/%Y')

Discrepancy_data <- Discrepancy_data %>% 
  rename(Discrepancy_values = V1)
  
plot(Discrepancy, main = "Plotting Discrepancy Between BSGP and Black-Scholes", xlab = "Plot Points", ylab = "Discrepancy in $")

#Plotting Blackscholes
ggplot(data=Discrepancy_data, mapping=aes(x=date, y=Discrepancy_values)) +
  geom_point(size = 2) +
  geom_line() +
  labs(title = "Plotting Mean Discrepancy Across Time",
       x = "Date",
       y = "Discrepancy in $") +
  theme_bw() +
  theme(text=element_text(size=16))
```

7-2: Discrepancy Contour Plots of Forward Price & Strike Price 

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$impl_volatility[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,1],K=x2_cont_bs[row,2],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,3],divrate=x2_cont_bs[row,5])$Price)
}

post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data


pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(Discrepancy_function, length(dim1), length(dim2)), labcex =1.5, main = "Discrepancy Modeled in 2D (Spot Price & Strike Price)", xlab= "Spot Price", ylab="Strike Price")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

7-3: Discrepancy Contour Plots of Implied Volatility & Time to Expiration

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$strike_price[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,4],r=x2_cont_bs[row,6],t=x2_cont_bs[row,2],vola=x2_cont_bs[row,1],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(Discrepancy_function, length(dim1), length(dim2)), labcex =1.5, main = "Discrepancy Modeling in 2D (Impl_vol & Time_to_Exp)", xlab= "Implied Volatility", ylab="Time to Expiration")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

7-4: Discrepancy Contour Plots of Strike Price & Implied Volatility

```{r}
x.grid_1_cont <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x.grid_2_cont <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])

dim1 <- seq(min(x.grid_1_cont),max(x.grid_1_cont),length.out = 25)
dim2 <- seq(min(x.grid_2_cont),max(x.grid_2_cont),length.out = 25)
X.grid <- expand.grid(x1 = dim1, x2 = dim2)

x.grid_3_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])),nrow(X.grid))
x.grid_4_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])),nrow(X.grid))
x.grid_5_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])),nrow(X.grid))
x.grid_6_cont <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])),nrow(X.grid))

x2_cont <- cbind(X.grid,x.grid_3_cont,x.grid_4_cont,x.grid_5_cont,x.grid_6_cont)

x.grid_1_cont_bs <- as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])
x.grid_2_cont_bs <- as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])
x.grid_3_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$forward_price[test_start:test_end])),nrow(X.grid))
x.grid_4_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$time_to_exp[test_start:test_end])),nrow(X.grid))
x.grid_5_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$dividend_yield[test_start:test_end])),nrow(X.grid))
x.grid_6_cont_bs <- as.numeric(rep(mean(stan_dat$total_puts_American$interest_rate[test_start:test_end])),nrow(X.grid))

dim1_bs <- seq(min(x.grid_1_cont_bs),max(x.grid_1_cont_bs),length.out = 25)
dim2_bs <- seq(min(x.grid_2_cont_bs),max(x.grid_2_cont_bs),length.out = 25)
X.grid_bs <- expand.grid(x1 = dim1_bs, x2 = dim2_bs)

x2_cont_bs <- cbind(X.grid_bs,x.grid_3_cont_bs,x.grid_4_cont_bs,x.grid_5_cont_bs,x.grid_6_cont_bs)

blackscholes_test_cont <- rep(NA,length(x2_cont_bs[,1]))
for (row in 1:nrow(data.frame(x2_cont_bs))){
  blackscholes_test_cont[row] <- as.numeric(blackscholes(-1,S0=x2_cont_bs[row,3],K=x2_cont_bs[row,1],r=x2_cont_bs[row,6],t=x2_cont_bs[row,4],vola=x2_cont_bs[row,2],divrate=x2_cont_bs[row,5])$Price)
}


post_data_cont_bs <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_cont,N1=length(stan_dat$x[,1]),N2=nrow(x2_cont), bs = blackscholes_test_cont,variables = 6)


# post_data

pred_gp_cont_bs <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_cont_bs,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
#Computing Mean
y_predict_values_cont_bs <- extract(pred_gp_cont_bs,permuted=FALSE)
y_mean_values_cont_bs <- c(colMeans(y_predict_values_cont_bs))
y_mean_values_cont_bs <- y_mean_values_cont_bs[1:(length(y_mean_values_cont_bs)-1)]

#Computing Standard Deviation
pred_gp_summary_cont_bs <- summary(pred_gp_cont_bs, sd=c("sd"))$summary
pred_gp_sd_cont_bs <- pred_gp_summary_cont_bs[, c("sd")]
y_sd_values_cont_bs <- pred_gp_sd_cont_bs[1:(length(pred_gp_sd_cont_bs)-1)]

#Discrepancy
Discrepancy_function <- y_mean_values_cont_bs - blackscholes_test_cont

par(mfrow = c(1, 2))
#Contour for Predictions aka mean values of predicitons
contour(dim1, dim2, matrix(Discrepancy_function, length(dim1), length(dim2)), labcex =1.5, main = "Discrepancy Modeling in 2D (Strike Price & Impl_vol)", xlab= "Strike Price", ylab="Implied Volatility")
points(x2_cont[,1], x2_cont[,2], pch = 19, cex = 0.5, col = "red")
```

##Part 8: Other Machine Learning Methods

8-1: Fitting ANN

```{r Fitting_ANN}
library(rstan)
source("gp.utility.R")
library(neuralnet)

# Fitting ANN model
stan_dat <- read_rdump('Financial_Data_Put_American.R')
train <- data.frame(stan_dat$train)
n <- names(data.frame(stan_dat$train))
nn <- neuralnet(y_scaled ~ x_1 + x_2 + x_3 + x_4 + x_5 + x_6, data=train, hidden=c(5,3),linear.output=TRUE ,threshold=0.01)
plot(nn)
```

8-2: Testing ANN

```{r Testing_ANN}
#Testing
test_start <- 323 #06/10 Puts
test_end <- 559 #06/14 Puts

# test_start <- 560 #06/17 Puts
# test_end <- 852 #06/20 Puts

# test_start <- 609 #06/10 Calls
# test_end <- 999 #06/14 Calls

# test_start <- 433 #06/17 Calls
# test_end <- 700 #06/20 Calls

x_1 <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start:test_end])
x_2 <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start:test_end])
x_3 <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start:test_end])
x_4 <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start:test_end])
x_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start:test_end])
x_6 <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start:test_end])
y_scaled <- as.numeric(stan_dat$total_puts_American$mid_price_scaled[test_start:test_end])
test <- data.frame(cbind(x_1,x_2,x_3,x_4,x_5,x_6,y_scaled))


predict_testNN <- neuralnet::compute(nn, test[,c(1:6)])
predict_testNN <- (predict_testNN$net.result * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(stan_dat$total_puts_American$mid_price[test_start:test_end], predict_testNN, col='blue', pch=16, ylab = "predicted price NN", xlab = "real price")
abline(0,1)


MSE(predict_testNN,stan_dat$total_puts_American$mid_price[test_start:test_end])
```

8-3 Fitting & Testing Bagging

```{r Fitting_Random Forest}
#Bagging
library(tree)
library(randomForest)

bagging <- randomForest(y_scaled~., data = train, mtry = 6, importance = TRUE)
bagging

yhat.bag <- predict(bagging, newdata = test)
yhat.bag <- (yhat.bag * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(yhat.bag, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((yhat.bag - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)


#Random Forest
rf <- randomForest(y_scaled~., data = train, mtry = 2, importance = TRUE)
yhat.rf <- predict(rf, newdata = test)
yhat.rf <- (yhat.rf * (max(stan_dat$total_puts_American$mid_price[test_start:test_end]) - min(stan_dat$total_puts_American$mid_price[test_start:test_end]))) + min(stan_dat$total_puts_American$mid_price[test_start:test_end])
plot(yhat.rf, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((yhat.rf - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)
```

8-4 Fitting & Testing Binomial Option Trees

```{r}
library(derivmkts)

x2_bs <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end]))

binom_test <- rep(NA,length(x2_bs[,1]))
for (row in 1:nrow(data.frame(x2_bs))){
  binom_test[row] <- binomopt(s=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],k=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],v=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],tt=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],d=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row], nstep = 6000, american=TRUE, putopt=TRUE)
}

plot(binom_test, stan_dat$total_puts_American$mid_price[test_start:test_end])
abline(0,1)
mean((binom_test - stan_dat$total_puts_American$mid_price[test_start:test_end])^2)
```


8-5 Summary of Other Machine Learning Methods

```{r summary of results for all methods}
par(mfrow=c(2,3))
#Plotting Standard GP
ggplot(mapping=aes(x=log(y_mean_values_SGP),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting bs
ggplot(mapping=aes(x=log(y_mean_values_bs),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


#Plotting Blackscholes
ggplot(mapping=aes(x=log(blackscholes_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

#Plotting Artificial Neural Networks
ggplot(mapping=aes(x=log(predict_testNN),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Neural Network",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Bagging
ggplot(mapping=aes(x=log(yhat.bag),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Bagging",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Random Forest
ggplot(mapping=aes(x=log(yhat.rf),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Random Forest",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#Plotting Binomial Option Tree
ggplot(mapping=aes(x=log(binom_test),y=log(stan_dat$total_puts_American$mid_price[test_start:test_end]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Binomial Option Tree",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16)) +
  geom_abline(intercept = 0, slope = 1)

#MSE
library('MLmetrics')
MSE(y_mean_values_SGP,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(y_mean_values_bs,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(blackscholes_test,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(predict_testNN,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(yhat.bag,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(yhat.rf,stan_dat$total_puts_American$mid_price[test_start:test_end])
MSE(binom_test,stan_dat$total_puts_American$mid_price[test_start:test_end])

#Computational Time
library('base')
#SGP
system.time(stan(file="gp-fit-6dimension_SGP.stan", data=stan_dat,
               iter=100, chains=1))
system.time(stan(file="Predictive GP_6dimension_SGP.stan", data=post_data_SGP_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param'))

#BSGP
system.time(stan(file="gp-fit-6dimension_withBS_SGP.stan", data=stan_dat,
               iter=100, chains=1))
system.time(stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param'))

#BS
system.time(for (row in 1:nrow(data.frame(x2_bs))){
  blackscholes_test[row] <- as.numeric(blackscholes(-1,S0=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],K=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],t=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],vola=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],divrate=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row])$Price)
})

#Neural Net
system.time(neuralnet(y_scaled ~ x_1 + x_2 + x_3 + x_4 + x_5 + x_6, data=train, hidden=c(5,3),linear.output=TRUE ,threshold=0.01))
system.time(neuralnet::compute(nn, test[,c(1:6)]))

#Bagging
system.time(randomForest(y_scaled~., data = train, mtry = 6, importance = TRUE))
system.time(predict(bagging, newdata = test))

#Random Forest
system.time(randomForest(y_scaled~., data = train, mtry = 2, importance = TRUE))
system.time(predict(rf, newdata = test))

#Binomial Option Tree
system.time(for (row in 1:nrow(data.frame(x2_bs))){
  binom_test[row] <- binomopt(s=as.numeric(stan_dat$total_puts_American$forward_price[test_start:test_end])[row],k=as.numeric(stan_dat$total_puts_American$strike_price[test_start:test_end])[row],v=as.numeric(stan_dat$total_puts_American$impl_volatility[test_start:test_end])[row],r=as.numeric(stan_dat$total_puts_American$interest_rate[test_start:test_end])[row],tt=as.numeric(stan_dat$total_puts_American$time_to_exp[test_start:test_end])[row],d=as.numeric(stan_dat$total_puts_American$dividend_yield[test_start:test_end])[row], nstep = 6000, american=TRUE, putopt=TRUE)
})
```

## Part 9: Delta Hedging Back-test

9-1 Computing Actual Delta for the next day

```{r}
tmr_start_backtest <- 394 #6/11
tmr_end_backtest <- 465 #6/11

test_start_backtest <- 323 #Start of 06/10 Puts
test_end_backtest <- 393 # End of 06/10 Puts


tmr_options <- stan_dat$total_puts_American[tmr_start_backtest:tmr_end_backtest,]
today_options <- stan_dat$total_puts_American[test_start_backtest:test_end_backtest,]

#filtering out options that are present both today and tmr
tmr_data <- stan_dat$total_puts_American$optionid[tmr_start_backtest:tmr_end_backtest]
today_data <- stan_dat$total_puts_American$optionid[test_start_backtest:test_end_backtest]

IDs<- unique(today_data[today_data%in%tmr_data])

tmr_option_price <- tmr_options %>% 
  filter(optionid %in% IDs == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
today_option_price <- today_options %>% 
  filter(optionid %in% IDs == TRUE) %>% 
  arrange(optionid) %>% 
  select(mid_price)
tmr_underlying_price <- tmr_options %>% 
  filter(optionid %in% IDs == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)
today_underlying_price <- today_options %>% 
  filter(optionid %in% IDs == TRUE) %>% 
  arrange(optionid) %>% 
  select(forward_price)

Real_delta <- as.vector(unlist((tmr_option_price-today_option_price)/(tmr_underlying_price-today_underlying_price)))

```

9-2 Generating BSGP prices for Backtesting

```{r Backtest-Setting test to today}


x_1_backtest <- as.numeric(stan_dat$total_puts_American$forward_price_scaled[test_start_backtest:test_end_backtest])
x_2_backtest <- as.numeric(stan_dat$total_puts_American$strike_price_scaled[test_start_backtest:test_end_backtest])
x_3_backtest <- as.numeric(stan_dat$total_puts_American$impl_volatility_scaled[test_start_backtest:test_end_backtest])
x_4_backtest <- as.numeric(stan_dat$total_puts_American$time_to_exp_scaled[test_start_backtest:test_end_backtest])
x_5_backtest <- as.numeric(stan_dat$total_puts_American$dividend_yield_scaled[test_start_backtest:test_end_backtest])
x_6_backtest <- as.numeric(stan_dat$total_puts_American$interest_rate_scaled[test_start_backtest:test_end_backtest])
x2_backtest <- cbind(x_1_backtest,x_2_backtest,x_3_backtest,x_4_backtest,x_5_backtest,x_6_backtest)[c(match(IDs,today_data)),]
```

```{r computing blackscholes for backtest}
x2_bs_backtest <- cbind(as.numeric(stan_dat$total_puts_American$forward_price[test_start_backtest:test_end_backtest]),as.numeric(stan_dat$total_puts_American$strike_price[test_start_backtest:test_end_backtest]),as.numeric(stan_dat$total_puts_American$impl_volatility[test_start_backtest:test_end_backtest]),as.numeric(stan_dat$total_puts_American$time_to_exp[test_start_backtest:test_end_backtest]),x.grid_5 <- as.numeric(stan_dat$total_puts_American$dividend_yield[test_start_backtest:test_end_backtest]),as.numeric(stan_dat$total_puts_American$interest_rate[test_start_backtest:test_end_backtest]))[c(match(IDs,today_data)),]


library('qrmtools')
library('ragtop')
blackscholes_test_backtest <- rep(NA,length(x2_bs_backtest[,1]))
for (row in 1:nrow(data.frame(x2_bs_backtest))){
  blackscholes_test_backtest[row] <- as.numeric(blackscholes(-1,S0=as.numeric(x2_bs_backtest[row,1]),K=as.numeric(x2_bs_backtest[row,2]),r=as.numeric(x2_bs_backtest[row,6]),t=as.numeric(x2_bs_backtest[row,4]),vola=as.numeric(x2_bs_backtest[row,3]),divrate=as.numeric(x2_bs_backtest[row,5]))$Price)
}

```

```{r Predictions_Backtest to predict for today}
# X.grid <- expand.grid(x1 = x.grid_1, x2 = x.grid_2)

post_data_bs_American_backtest <- list(theta=c(post_mean_theta_1_bs,post_mean_theta_2_bs,post_mean_theta_3_bs,post_mean_theta_4_bs,post_mean_theta_5_bs,post_mean_theta_6_bs),sigma2=post_mean_sigma2_bs,gamma2=post_mean_gamma2_bs,mu=post_mean_mu_bs,x_train=stan_dat$x,y1=stan_dat$y,x_test=x2_backtest,N1=length(stan_dat$x[,1]),N2=length(x2_backtest[,1]), bs = blackscholes_test_backtest,variables = 6)
# post_data

pred_gp_bs_backtest <- stan(file="Predictive GP_6dimension_withBS_SGP.stan", data=post_data_bs_American_backtest,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')
```

```{r Mean & SD of Predictions_bs}
#Computing Mean
y_predict_values_bs_backtest <- extract(pred_gp_bs_backtest,permuted=FALSE)
y_mean_values_bs_backtest <- c(colMeans(y_predict_values_bs_backtest))
y_mean_values_bs_backtest <- y_mean_values_bs_backtest[1:(length(y_mean_values_bs_backtest)-1)]

#Computing Standard Deviation
pred_gp_summary_bs_backtest <- summary(pred_gp_bs_backtest, sd=c("sd"))$summary
pred_gp_sd_bs_backtest <- pred_gp_summary_bs_backtest[, c("sd")]
y_sd_values_bs_backtest <- pred_gp_sd_bs_backtest[1:(length(pred_gp_sd_bs_backtest)-1)]
```

```{r predictive performance of backtest price for today}
ggplot(mapping=aes(x=log(y_mean_values_bs_backtest),y=log(cbind(stan_dat$total_puts_American$mid_price[test_start_backtest:test_end_backtest])[c(match(IDs,today_data))]))) +
  geom_point() +
  labs(title = "Predicted vs Data - Black-Scholes Integrated SGP",
       x = "Predicted Option Price",
       y = "Observed Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

MSE(y_mean_values_bs_backtest,cbind(stan_dat$total_puts_American$mid_price[test_start_backtest:test_end_backtest])[c(match(IDs,today_data))])
```

9-3 Computing BS Delta

```{r compute BSGP delta}
library(derivmkts)
BS_Delta <- greeks(bsput(s=as.numeric(x2_bs_backtest[,1]), k=as.numeric(x2_bs_backtest[,2]), v=as.numeric(x2_bs_backtest[,3]), r=as.numeric(x2_bs_backtest[,6]), tt=as.numeric(x2_bs_backtest[,4]), d=as.numeric(x2_bs_backtest[,5])), complete=TRUE, long=FALSE, initcaps=TRUE)$Delta

BS_Delta
```

9-4 Computing BSGP vector C & vector K'

```{r}
vector_c_values <- stan(file="Predictive GP_6dimension_withBS_SGP_vectorc.stan", data=post_data_bs_American_backtest,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')


vector_c_values <- extract(vector_c_values,permuted=FALSE)
vector_c_values <- c(colMeans(vector_c_values))
vector_c_values <- vector_c_values[1:(length(vector_c_values)-1)]

vector_k_values <- stan(file="Predictive GP_6dimension_withBS_SGP_vectork.stan", data=post_data_bs_American_backtest,iter=200, warmup=0, chains=1, seed=5838298, refresh=100, algorithm = 'Fixed_param')



vector_k_values <- extract(vector_k_values,permuted=FALSE)
vector_k_values <- c(colMeans(vector_k_values))
vector_k_values <- vector_k_values[1:(length(vector_k_values)-1)]


vector_k <- matrix(vector_k_values, nrow(x2_backtest), nrow(stan_dat$x), byrow=FALSE)

BSGP_Delta <- BS_Delta + vector_k %*% vector_c_values

```

9-5 Choosing which options to use

```{r}
# hist(BS_Delta-BSGP_Delta)
# selected_options <- sort(BS_Delta-BSGP_Delta, index.return=TRUE, decreasing=TRUE)$ix[1]
# BSGP_Delta[c(selected_options)]
# BS_Delta[c(selected_options)]

# BSGP_Delta_portfolio <- sum(BSGP_Delta[c(selected_options)])
# BS_Delta_portfolio <- sum(BS_Delta[c(selected_options)])

BSGP_Delta_portfolio <- sum(BSGP_Delta)
BS_Delta_portfolio <- sum(BS_Delta)

##Assuming we hedge with the SPY closing price
##6/10 closing price for SPY: 288.97
##6/11 closing price for SPY: 288.9

BSGP_hedge_cost <-288.97*abs(BSGP_Delta_portfolio)*100
BS_hedge_cost <- 288.97*abs(BS_Delta_portfolio)*100

BSGP_portfolio_value_change <- (sum(tmr_option_price$mid_price)-sum(today_option_price$mid_price)) + ((288.9-288.97)*abs(BSGP_Delta_portfolio)*100)

BS_portfolio_value_change <- (sum(tmr_option_price$mid_price)-sum(today_option_price$mid_price)) + ((288.9-288.97)*abs(BS_Delta_portfolio)*100)

BSGP_portfolio_value_change
BS_portfolio_value_change

##Problem is that there is no way to figure out if positive discrepancy is better or if negative discrepancy is better!!!!
```


9-6 Comparing Performance

```{r}
mean(abs(BSGP_Delta - Real_delta))
mean(abs(BS_Delta - Real_delta))

Delta_data <- cbind(BSGP_Delta,BS_Delta)

ggplot(mapping=aes(x=BSGP_Delta,y=Real_delta)) +
  geom_point() +
  labs(title = "BSGP Delta vs Actual Delta",
       x = "BSGP Delta",
       y = "Observed Delta") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)


ggplot(mapping=aes(x=BS_Delta,y=Real_delta)) +
  geom_point() +
  labs(title = "BS Delta vs Actual Delta",
       x = "BS Delta",
       y = "Observed Delta") +
  theme_bw() +
  theme(text=element_text(size=16))+
  geom_abline(intercept = 0, slope = 1)

matplot(Delta_data,Real_delta,type="o", xlab = "BSGP Delta & BS Delta", ylab = "Observed Delta")

```

10.Learning the Influence Coefficient

10-1 Distribution of Influence Coefficient

```{r}
IC <- abs(vector_c_values)
ggplot(mapping = aes(x=IC)) + geom_histogram()+
  labs(title = "Distribution of Influence Coefficient",
       x = "Values of Influence Coefficient",
       y = "Frequency") +
  theme_bw() +
  theme(text=element_text(size=16))

High_DAD <- c()
for (number in IC){
  if (number > unname(quantile(IC)[4])){
    High_DAD <- append(High_DAD,number)
  }
}

Low_DAD <- c()
for (number in IC){
  if (number < unname(quantile(IC)[2])){
    Low_DAD <- append(Low_DAD,number)
  }
}

High_DAD_data <- stan_dat$x[match(High_DAD,IC),]
Low_DAD_data <- stan_dat$x[match(Low_DAD,IC),]
DAD_data <- rbind(High_DAD_data,Low_DAD_data) 
DAD_values <- c(rep(1,times=length(High_DAD)), rep(0,times=length(Low_DAD)))

Training_option_price <- append(stan_dat$y[match(High_DAD,IC)], stan_dat$y[match(Low_DAD,IC)])
```

Try out decision tree/classification tree after dividing the DADs into two groups "High DAD" & "Low DAD" by median, maybe even random forest or more -> trying to visualize where the data is influential

10-2 Color Coded Map of Influence Coefficient

```{r}
# library(grid)
# grid.newpage()
#Spot vs Strike
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,2], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Strike",
       x = "Spot Price",
       y = "Strike Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Implied Volatility
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,3], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Implied Volatility",
       x = "Spot Price",
       y = "Implied Volatility") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Time to Expiration
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,4], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Time to Expiration",
       x = "Spot Price",
       y = "Time to Expiration") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Dividend Yield
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,5], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Dividend Yield",
       x = "Spot Price",
       y = "Dividend Yield") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Interest Rate
ggplot(mapping=aes(x=DAD_data[,1],y=DAD_data[,6], color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Interest Rate",
       x = "Spot Price",
       y = "Interest Rate") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

#Spot vs Option Price
ggplot(mapping=aes(x=DAD_data[,1],y=Training_option_price, color = DAD_values)) +
  geom_point(size = 2) +
  labs(title = "Influence Coefficient in Training Data - Spot vs Option Price",
       x = "Spot Price",
       y = "Option Price") +
  theme_bw() +
  theme(text=element_text(size=16))+
  scale_colour_gradient(low="blue", high="red")

```



##Evaluate based on payoff of the delta hedge rather than comparing with the realized delta V

##Prove the point of delta hedging(why use delta hedging with graphs)

##EDITS on JBES

##quantize it to 0's and 1's to make low DAD and high DADs. or maybe even more classes. 

##Look into finance fintech quant conferences to submit

